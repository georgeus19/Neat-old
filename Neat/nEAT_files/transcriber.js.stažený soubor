"use strict";function getLogger(n,t){var i=new bUlsCache(n,t);return{ULS:{trace:function(n,t,r){return traceTagImpl(i,0,n,t,r)},traceTag:function(n,t,r,u){return traceTagImpl(i,n,t,r,u)},flush:i.flush,flushOnClose:i.flushOnClose}}}function traceTagImpl(n,t,i,r,u){if(!(r>currentLevel)){var f={timestamp:Date.now(),category:i,tag:t,level:r,type:logType.Trace,message:u};n.handleTrace(f)}}function formatForUpload(n,t,i,r){var u=n.map(function(n){return getLogEntryInWireFormat(n,r)}),f=getLogBatchInWireFormat(r,u,t,i);return JSON.stringify(f)}function getLogEntryInWireFormat(n,t){var i={},r;return i.G=n.tag,i.T=n.timestamp-t,i.M=n.message,i.C=n.category,r=n.type*shiftFactory+n.level,i.D=r,i}function getLogBatchInWireFormat(n,t,i,r){var u={};return u.T=n,u.L=t,u.S=i,u.I=r,u.V=1,u}function uploadLogs(n,t,i){if(t!==""){var r=new XMLHttpRequest;(r.readyState===XMLHttpRequest.UNSENT||r.readyState===XMLHttpRequest.DONE)&&(r.open("POST",t,i),r.send(n))}}var logLevel,ULS,currentLevel,bUlsCache,shiftFactory,logCategory,logType,PowerPointOnline;(function(n){n[n.Spam=200]="Spam";n[n.Verbose=100]="Verbose";n[n.Info=50]="Info";n[n.Warning=15]="Warning";n[n.Error=10]="Error"})(logLevel||(logLevel={}));ULS={getLogger:getLogger};currentLevel=logLevel.Info;bUlsCache=function(){function n(t,i){var r=this;this.uploadId=0;this.logCache=[];this.timestampBase=Date.now();this.userSessionId="00000000-0000-0000-0000-000000000000";this.flushOnClose=function(){r.triggerUpload(!1,!1)};this.flush=function(){r.triggerUploadAsync()};this.triggerUploadAsync=function(){window.setTimeout(function(){return r.triggerUpload(!0,!0)},0)};this.triggerUpload=function(t,i){if(window.clearTimeout(r.timeoutId),r.logCache.length>0){r.uploadId+=1;var u=formatForUpload(r.logCache,r.userSessionId,r.uploadId,r.timestampBase);uploadLogs(u,r.remoteUrlEndpoint,i);r.logCache=[];r.timestampBase=Date.now()}t&&(r.timeoutId=window.setTimeout(r.triggerUploadAsync,n.uploadCadenceInMsSec))};this.userSessionId=t;this.remoteUrlEndpoint=i+"?usid="+t;window.setTimeout(function(){return r.triggerUpload(!0,!0)},0)}return n.prototype.handleTrace=function(t){t.message.length>n.messageMaxChars&&(t.message=t.message.substr(0,n.messageMaxChars-n.trimedMessage.length)+n.trimedMessage);this.logCache.push(t);(this.logCache.length>n.uploadTriggerSize||t.level===logLevel.Error)&&this.triggerUploadAsync()},n.messageMaxChars=3072,n.uploadCadenceInMsSec=3e4,n.uploadTriggerSize=30,n.trimedMessage="... [Trimmed]",n}();shiftFactory=1e3,function(n){n[n.WordViewer=301]="WordViewer";n[n.WopiPendingApplication=379]="WopiPendingApplication";n[n.VisioApp=700]="VisioApp";n[n.PptNavigation=810]="PptNavigation";n[n.PptSession=817]="PptSession";n[n.PptVersionHistory=832]="PptVersionHistory";n[n.PptLive=833]="PptLive"}(logCategory||(logCategory={})),function(n){n[n.Trace=0]="Trace";n[n.Assert=1]="Assert"}(logType||(logType={})),function(n){var t;(function(n){var r=function(){function n(){}return n.prototype.trace=function(n,t,i){this.traceTag(0,n,t,i)},n.prototype.traceTag=function(n,t,i,r){var u=null;switch(i){case logLevel.Verbose:u=console.debug;break;case logLevel.Info:u=console.log;break;case logLevel.Warning:case logLevel.Error:u=console.error;break;default:u=console.error}u(r)},n}(),t,i;n.ConsoleSessionLogger=r;t=function(){function n(n,t){try{this.logger=ULS.getLogger(n,t+"RemoteUls.ashx")}catch(i){}}return n.prototype.trace=function(n,t,i){this.logger!=null&&this.logger.ULS.trace(n,t,i)},n.prototype.traceTag=function(n,t,i,r){this.logger!=null&&this.logger.ULS.traceTag(n,t,i,r)},n.prototype.flush=function(){this.logger!=null&&this.logger.ULS.flush()},n.prototype.flushOnClose=function(){this.logger!=null&&this.logger.ULS.flushOnClose()},n}();n.UlsSessionLogger=t;i=function(){function n(){}return n.init=function(n){this.logger=n},n.trace=function(n,t,i){this.logger!=null&&this.logger.trace(n,t,i)},n.traceTag=function(n,t,i,r){this.logger!=null&&this.logger.traceTag(n,t,i,r)},n}();n.SessionLogger=i})(t=n.Telemetry||(n.Telemetry={}))}(PowerPointOnline||(PowerPointOnline={}));"use strict";var RehearsalTemplate;(function(a){a[a.DetectedValueWithMessage=0]="DetectedValueWithMessage";a[a.SingleMessage=1]="SingleMessage";a[a.GaugeWithMessage=2]="GaugeWithMessage"})(RehearsalTemplate||(RehearsalTemplate={}));var RehearsalState;(function(a){a[a.NotStarted=0]="NotStarted";a[a.Started=1]="Started";a[a.Paused=2]="Paused";a[a.Stopped=3]="Stopped"})(RehearsalState||(RehearsalState={}));var RehearsalSettings=function(){function a(){}a.ColorRed="#b30921";a.ColorOrange="#f8a728";a.ColorGreen="#75d770";a.ColorWhite="#ffffff";a.OriginalityOverlapThreshold=.5;a.UpdateTimerIntervalInMS=1e3;a.FillerWordsKey="fillerWords";a.OriginalityKey="originality";a.WordsPerMinuteKey="wordsPerMinute";a.SensitivePhrasesKey="sensitivePhrases";a.CorrectedSensitivePhrasesKey="correctedSensitivePhrases";a.PriorityKey="priority";a.TimeoutInMSKey="timeoutInMS";a.RealtimeLabelKey="realtimeLabel";a.MessageKey="message";a.GaugeRotationKey="gaugeRotation";a.FEnsureDisplayGaugeKey="fEnsureDisplayGauge";a.OriginalityThresholdKey="originalityThreshold";a.ResetRehearsalIntervalInMS=5e3;a.RehearsalDashboardResizingWaitTimeInMS=500;a.RehearsalDashboardWidth="206px";a.RehearsalDashboardMinimizedHeight="16px";a.RehearsalDashboardMaximizedHeight="154px";a.RehearsalDashboardFirstRunMaximizedHeight="384px";a.RehearsalDashboardGenericWelcomeDivHeight="134px";a.RehearsalDashboardFirstRunWelcomeDivHeight="364px";a.RehearsalDashboardMinimizeTransition="all .5s linear";a.RehearsalDashboardMaximizeTransition="all .35s linear";a.RehearsalDashboardNoTransition="0ms";a.GenericRealtimeLabel="Rehearsal Coach";a.RehearsalWelcomeScreenTitle="Welcome to PowerPoint Presenter Coach";a.RehearsalFirstRunWelcomeScreenText="As you rehearse, we'll give you feedback about how you're presenting. At the end, you'll see a numerical summary and our suggestions.";a.RehearsalGenericWelcomeScreenText="Practice helps you better understand your content.";a.RehearsalGetStartedButtonLabel="Get Started";a.FRehearsalAlreadyTriggeredDuringSession=false;a.RehearsalKeyboardFocusTabIndex=3;a.RehearsalAlertSoundFilePath="pptscripts/rehearsalAlert.wav";a.RehearsalPauseButtonFilePath="pptscripts/pauseButton.png";a.RehearsalPlayButtonFilePath="pptscripts/playButton.png";a.RehearsalWelcomeScreenGraphicFilePath="pptscripts/welcomeGraphic.png";return a}(),RehearsalTemplateName=function(){function a(){}a.DetectedValueWithMessage="detectedvaluewithmessage";a.GaugeWithMessage="gaugewithmessage";a.SingleMessage="singlemessage";return a}(),RehearsalSessionTelemetry=function(){function a(){this.SuggestionCountsByName={}}return a}();function formatTimerNumber(a){return a<10?"0"+a:a}function updateTimer(){var a=Rehearsal.s_instance;if(a&&a.m_rehearsalState==RehearsalState.Started&&a.m_rehearsalPresentationTimerDiv!=null){++a.m_presentationTimeInSeconds;var b=Math.floor(a.m_presentationTimeInSeconds/3600),c=Math.floor((a.m_presentationTimeInSeconds-b*3600)/60),d=a.m_presentationTimeInSeconds-(b*3600+c*60);a.m_rehearsalPresentationTimerDiv.innerHTML=formatTimerNumber(b)+":"+formatTimerNumber(c)+":"+formatTimerNumber(d)}}function togglePause(){var a=Rehearsal.s_instance;if(a){if(a.m_rehearsalState==RehearsalState.Paused){a.m_rehearsalState=RehearsalState.Started;if(a.m_rehearsalPauseButtonDiv!=null&&a.m_rehearsalPlayButtonDiv!=null&&a.m_rehearsalRealtimeLabelSpan!=null){a.m_rehearsalPlayButtonDiv.style.display="none";a.m_rehearsalPauseButtonDiv.style.display="inline-block";a.m_rehearsalRealtimeLabelSpan.innerHTML="Go ahead";a.RestartTimerForClearingRehearsalDashboard()}}else{a.m_rehearsalState=RehearsalState.Paused;a.m_sessionTelemetry.NumberOfPauses++;if(a.m_rehearsalPauseButtonDiv!=null&&a.m_rehearsalPlayButtonDiv!=null&&a.m_rehearsalRealtimeLabelSpan!=null){a.m_rehearsalPlayButtonDiv.style.display="inline-block";a.m_rehearsalPauseButtonDiv.style.display="none";a.m_rehearsalRealtimeLabelSpan.innerHTML="Paused"}}resetFocus()}}function onMouseDownClickedGetStarted(a){a.preventDefault();return false}function resetFocus(){var a=document.getElementById("focusTrap1");a&&a.focus()}function userClickedGetStarted(b){var a=Rehearsal.s_instance;if(a){a.StartRehearsal();a.m_sessionTelemetry.RehearsalStartTime=Date.now();a.m_sessionTelemetry.FRehearsalDidStart=true;if(a.m_rehearsalId!=null)SessionLogger.traceTag(42014670,logCategory.PptSession,logLevel.Info,"Rehearsal::userClickedGetStarted Get Started button clicked. RehearsalID: "+a.m_rehearsalId);else SessionLogger.traceTag(42014671,logCategory.PptSession,logLevel.Error,"Rehearsal::userClickedGetStarted Get Started button clicked without RehearsalID set.")}resetFocus();b.stopPropagation();return false}function disableContextMenu(a){a.preventDefault();return false}function resetRehearsalDashboard(){var a=Rehearsal.s_instance;if(a&&a.m_rehearsalDiv!=null&&a.m_rehearsalState==RehearsalState.Started&&a.m_rehearsalActiveTrackerDiv!=null&&a.m_rehearsalTopBarDiv!=null){a.m_rehearsalTopBarDiv.style.display="none";a.m_rehearsalActiveTrackerDiv.style.display="none";a.m_rehearsalActiveTrackerDiv=null;a.m_rehearsalDiv.style.transition=RehearsalSettings.RehearsalDashboardMinimizeTransition;a.m_rehearsalDiv.style.height=RehearsalSettings.RehearsalDashboardMinimizedHeight;a.m_timerForClearingRehearsalDashboard=null;if(a.m_currentlyShownFeatureName!=null)a.m_currentlyShownFeatureName=""}}function showActiveRehearsalTracker(){var a=Rehearsal.s_instance;if(a&&a.m_rehearsalActiveTrackerDiv!=null&&a.m_rehearsalTopBarDiv!=null){a.m_rehearsalTopBarDiv.style.display="initial";a.m_rehearsalActiveTrackerDiv.style.display="initial"}if(a)a.m_timerForShowActiveRehearsalTracker=null}var DragDropPositionTracker=function(){function a(c,b,a){this.isDragging=false;this.initialX=0;this.initialY=0;this.offsetX=0;this.offsetY=0;this.dragDiv=c;this.prevTransition=b;this.dragDropContainer=a}a.prototype.handleEvent=function(a){switch(a.type){case"mousedown":case"touchstart":this.dragStart(a);break;case"mouseup":case"touchend":this.dragEnd(a);break;case"mousemove":case"touchmove":this.dragging(a)}};a.prototype.dragStart=function(a){if(this.dragDiv.contains(a.target)){a.preventDefault();a.stopPropagation();this.isDragging=true;if(a.type=="mousedown"){this.initialX=a.clientX-this.offsetX;this.initialY=a.clientY-this.offsetY}else if(a.type=="touchstart"){this.initialX=a.touches[0].clientX-this.offsetX;this.initialY=a.touches[0].clientY-this.offsetY}this.dragDropContainer.style.display="block"}};a.prototype.dragging=function(a){if(this.isDragging){a.preventDefault();a.stopPropagation();if(a.type=="mousemove"){this.offsetX=a.clientX-this.initialX;this.offsetY=a.clientY-this.initialY}else if(a.type=="touchmove"){this.offsetX=a.touches[0].clientX-this.initialX;this.offsetY=a.touches[0].clientY-this.initialY}this.dragDiv.style.transition=RehearsalSettings.RehearsalDashboardNoTransition;this.dragDiv.style.transform="translate("+this.offsetX+"px, "+this.offsetY+"px)"}};a.prototype.dragEnd=function(a){if(this.isDragging){a.preventDefault();a.stopPropagation();this.isDragging=false;this.dragDiv.style.transition=this.prevTransition;this.dragDropContainer.style.display="none"}};a.prototype.addEventHandlers=function(){document.addEventListener("mousedown",this,true);document.addEventListener("mouseup",this,true);document.addEventListener("mousemove",this,true);document.addEventListener("touchstart",this,true);document.addEventListener("touchend",this,true);document.addEventListener("touchmove",this,true)};a.prototype.removeEventHandlers=function(){document.removeEventListener("mousedown",this,true);document.removeEventListener("mouseup",this,true);document.removeEventListener("mousemove",this,true);document.removeEventListener("touchstart",this,true);document.removeEventListener("touchend",this,true);document.removeEventListener("touchmove",this,true)};return a}(),Rehearsal=function(){function a(){this.m_sessionTelemetry=new RehearsalSessionTelemetry;this.m_rehearsalId="";this.m_currentlyShownFeatureName="";this.m_disabledRealtimeFeatures={}}a.GetInstance=function(){return this.s_instance||(this.s_instance=new this)};a.GetSupportedRehearsalTemplates=function(){var b="";for(var a in RehearsalTemplateName)if(a!=null&&a.length>0)b+=b.length==0?a:","+a;return b};a.GetRequestedRehearsalFeatures=function(){return RehearsalSettings.WordsPerMinuteKey+","+RehearsalSettings.FillerWordsKey+","+RehearsalSettings.SensitivePhrasesKey+","+RehearsalSettings.CorrectedSensitivePhrasesKey+","+RehearsalSettings.OriginalityKey};a.GetRehearsalMetadataJSON=function(){return JSON.stringify({requestedRehearsalFeatures:a.GetRequestedRehearsalFeatures(),supportedRehearsalTemplates:a.GetSupportedRehearsalTemplates()})};a.FSupportsRehearsalTemplate=function(a){if(a==null)return false;switch(a.toLowerCase()){case RehearsalTemplateName.DetectedValueWithMessage:case RehearsalTemplateName.GaugeWithMessage:case RehearsalTemplateName.SingleMessage:return true;default:return false}};a.DisposeInstance=function(){var b=a.s_instance;b&&b.EndRehearsal()};a.prototype.Initialize=function(d,b,c,a){this.DisposeRehearsalInternal();this.InitializeRehearsalInternal(d,b,c,a)};a.prototype.StartRehearsal=function(){this.StartRealTimeTrackers();this.m_rehearsalGetStartedButton&&this.m_rehearsalGetStartedButton.blur();if(this.m_rehearsalDiv){this.m_rehearsalDiv.removeAttribute("role");this.m_rehearsalDiv.removeAttribute("aria-role");this.m_rehearsalDiv.removeAttribute("aria-live")}var a=RehearsalSummaryCollector.GetRehearsalSummaryControlInstance();a!=null&&a.StartRehearsal();RehearsalSettings.FRehearsalAlreadyTriggeredDuringSession=true};a.prototype.EndRehearsal=function(){var a=RehearsalSummaryCollector.GetRehearsalSummaryControlInstance();a!=null&&a.StopRehearsal();this.LogEndOfRehearsalSessionTelemetry();this.DisposeRehearsalInternal()};a.prototype.UpdateSlideTracker=function(a){if(this.m_rehearsalSlideTrackerDiv!=null&&this.m_slideCount!=null)this.m_rehearsalSlideTrackerDiv.innerHTML=String(++a)+" of "+String(this.m_slideCount)};a.prototype.RestartTimerForClearingRehearsalDashboard=function(){this.m_timerForClearingRehearsalDashboard&&clearTimeout(this.m_timerForClearingRehearsalDashboard);this.m_timerForClearingRehearsalDashboard=setTimeout(resetRehearsalDashboard,RehearsalSettings.ResetRehearsalIntervalInMS)};a.prototype.InitializeRehearsalSessionTelemetry=function(){this.m_sessionTelemetry=new RehearsalSessionTelemetry;this.m_sessionTelemetry.FRehearsalDidStart=false;this.m_sessionTelemetry.SuggestionCountsByName={};this.m_sessionTelemetry.NumberOfPauses=0;this.m_sessionTelemetry.RehearsalStartTime=0;this.m_sessionTelemetry.RehearsalEndTime=0};a.prototype.LogEndOfRehearsalSessionTelemetry=function(){var a=RehearsalSummaryCollector.GetRehearsalSummaryStateInstance(),b=a.GetSortedSensitivePhrases(true);if(a!=null){this.m_sessionTelemetry.NumberOfSlidesRehearsed=a.GetSlidesRehearsed().length;this.m_sessionTelemetry.RehearsalDurationInSeconds=a.GetTimeSpent();this.m_sessionTelemetry.NumberOfSlidesWithOriginalitySuggestion=a.GetOriginalityProblemSlides().length;this.m_sessionTelemetry.DetectedFillerWords=a.GetFillers();this.m_sessionTelemetry.DetectedSensitivePhrases=b.map(function(a){return a.phraseData});this.m_sessionTelemetry.DetectedCorrectedSensitivePhrases=b.map(function(a){return a.correction})}this.m_sessionTelemetry.RehearsalEndTime=Date.now();this.m_sessionTelemetry.FDidSeeSuggestions=Object.keys(this.m_sessionTelemetry.SuggestionCountsByName).length>0;SessionLogger.traceTag(42014672,logCategory.PptSession,logLevel.Info,JSON.stringify(this.m_sessionTelemetry))};a.prototype.FireRehearsalTrackerAriaAlert=function(){if(this.m_rehearsalActiveTrackerDiv){this.m_rehearsalActiveTrackerDiv.removeAttribute("aria-live");this.m_rehearsalActiveTrackerDiv.removeAttribute("aria-role");this.m_rehearsalActiveTrackerDiv.removeAttribute("role");this.m_rehearsalActiveTrackerDiv.setAttribute("role","alert");this.m_rehearsalActiveTrackerDiv.setAttribute("aria-role","alert");this.m_rehearsalActiveTrackerDiv.setAttribute("aria-live","assertive")}};a.prototype.DisplayActiveRehearsalTracker=function(c,b){if(this.m_rehearsalDiv==null)return;var a=this.m_currentlyShownFeatureName==null||this.m_currentlyShownFeatureName!=b;if(this.m_rehearsalActiveTrackerDiv!=null){if(a){this.m_rehearsalActiveTrackerDiv.removeAttribute("aria-live");this.m_rehearsalActiveTrackerDiv.removeAttribute("aria-role");this.m_rehearsalActiveTrackerDiv.removeAttribute("role")}this.m_rehearsalActiveTrackerDiv.style.display="none"}this.m_rehearsalActiveTrackerDiv=c;this.m_rehearsalDiv.style.transition=RehearsalSettings.RehearsalDashboardMaximizeTransition;this.m_rehearsalDiv.style.height=RehearsalSettings.RehearsalDashboardMaximizedHeight;if(this.FRehearsalDashboardIsMinimized()){this.m_timerForShowActiveRehearsalTracker&&clearTimeout(this.m_timerForShowActiveRehearsalTracker);this.m_timerForShowActiveRehearsalTracker=setTimeout(showActiveRehearsalTracker,RehearsalSettings.RehearsalDashboardResizingWaitTimeInMS);this.PlayRehearsalAlertSound()}else if(this.m_rehearsalTopBarDiv!=null&&this.m_rehearsalActiveTrackerDiv!=null&&this.m_timerForShowActiveRehearsalTracker==null){this.m_rehearsalTopBarDiv.style.display="initial";this.m_rehearsalActiveTrackerDiv.style.display="initial"}this.RestartTimerForClearingRehearsalDashboard();a&&this.FireRehearsalTrackerAriaAlert();this.m_currentlyShownFeatureName=b};a.prototype.FRehearsalDashboardIsMinimized=function(){return this.m_rehearsalTopBarDiv!=null&&this.m_rehearsalTopBarDiv.style.display=="none"&&this.m_timerForShowActiveRehearsalTracker==null};a.prototype.UpdateSuggestionCountInTelemetry=function(a){if(a.toLowerCase()in this.m_sessionTelemetry.SuggestionCountsByName)this.m_sessionTelemetry.SuggestionCountsByName[a.toLowerCase()]++;else this.m_sessionTelemetry.SuggestionCountsByName[a.toLowerCase()]=1};a.prototype.ShowDetectedValueWithMessage=function(c,b,a){if(b!=null&&b.length>0&&a.has(RehearsalSettings.MessageKey)&&this.m_rehearsalDetectedValueWithMessageDiv!=null&&this.m_rehearsalDetectedValueWithMessageValueSpan!=null&&this.m_rehearsalDetectedValueWithMessageMessageSpan!=null&&this.m_rehearsalRealtimeLabelSpan!=null){var d=String(a.get(RehearsalSettings.MessageKey));this.UpdateSuggestionCountInTelemetry(c);this.m_rehearsalDetectedValueWithMessageValueSpan.innerHTML='"'+b+'"';this.m_rehearsalDetectedValueWithMessageMessageSpan.innerHTML=d;this.m_rehearsalRealtimeLabelSpan.innerHTML=a.has(RehearsalSettings.RealtimeLabelKey)?a.get(RehearsalSettings.RealtimeLabelKey):RehearsalSettings.GenericRealtimeLabel;this.DisplayActiveRehearsalTracker(this.m_rehearsalDetectedValueWithMessageDiv,c)}};a.prototype.ShowGaugeWithMessage=function(c,d,a){if(d!=null&&d.length>0&&a.has(RehearsalSettings.MessageKey)&&a.has(RehearsalSettings.GaugeRotationKey)&&a.has(RehearsalSettings.FEnsureDisplayGaugeKey)&&this.m_rehearsalGaugeWithMessageLabel!=null&&this.m_rehearsalGaugeWithMessageTicker!=null&&this.m_rehearsalGaugeWithMessageDiv!=null&&this.m_rehearsalRealtimeLabelSpan!=null){var b=Number(a.get(RehearsalSettings.GaugeRotationKey));if(b>=0&&b<=1){this.m_currentlyShownFeatureName!=c&&this.UpdateSuggestionCountInTelemetry(c);var g=Number(d),f=String(a.get(RehearsalSettings.MessageKey)),e=-90+180*b;this.m_rehearsalGaugeWithMessageTicker.style.transform="rotate("+String(e)+"deg)";this.m_rehearsalGaugeWithMessageLabel.innerText=f;if(String(a.get(RehearsalSettings.FEnsureDisplayGaugeKey)).toLowerCase()=="true"){this.m_rehearsalRealtimeLabelSpan.innerHTML=a.has(RehearsalSettings.RealtimeLabelKey)?a.get(RehearsalSettings.RealtimeLabelKey):RehearsalSettings.GenericRealtimeLabel;this.DisplayActiveRehearsalTracker(this.m_rehearsalGaugeWithMessageDiv,c)}}}};a.prototype.ShowSingleMessage=function(b,c,a){if(c!=null&&c.length>0&&a.has(RehearsalSettings.MessageKey)&&this.m_rehearsalSingleMessageDiv!=null&&this.m_rehearsalSingleMessageSpan!=null&&this.m_rehearsalRealtimeLabelSpan!=null){this.m_currentlyShownFeatureName!=b&&this.UpdateSuggestionCountInTelemetry(b);this.m_rehearsalSingleMessageSpan.innerHTML=String(a.get(RehearsalSettings.MessageKey));this.m_rehearsalRealtimeLabelSpan.innerHTML=a.has(RehearsalSettings.RealtimeLabelKey)?a.get(RehearsalSettings.RealtimeLabelKey):RehearsalSettings.GenericRealtimeLabel;this.DisplayActiveRehearsalTracker(this.m_rehearsalSingleMessageDiv,b)}};a.prototype.GenerateRealtimeNotification=function(c,b){var e=b.getFeaturetemplate(),d=b.getFeaturevalue(),a=b.getTemplateinfoMap();switch(e.toLowerCase()){case RehearsalTemplateName.DetectedValueWithMessage:this.ShowDetectedValueWithMessage(c,d,a);break;case RehearsalTemplateName.GaugeWithMessage:this.ShowGaugeWithMessage(c,d,a);break;case RehearsalTemplateName.SingleMessage:this.ShowSingleMessage(c,d,a);break;default:SessionLogger.traceTag(42259011,logCategory.PptSession,logLevel.Error,"Rehearsal::GenerateRealtimeNotification Unhandled Template: "+e);return}};a.prototype.UpdateRehearsalDashboard=function(g){var k=this;if(this.m_rehearsalState!=RehearsalState.Started)return;var b=g.getFeaturesMap(),d="",e=-1;b.forEach(function(b,f){var c=f.toLowerCase();if(!(c in k.m_disabledRealtimeFeatures&&k.m_disabledRealtimeFeatures[c])&&a.FSupportsRehearsalTemplate(b.getFeaturetemplate())&&b.getTemplateinfoMap().has(RehearsalSettings.PriorityKey)&&Number(b.getTemplateinfoMap().has(RehearsalSettings.PriorityKey))>e){e=Number(b.getTemplateinfoMap().get(RehearsalSettings.PriorityKey));d=f}});if(e>=0){var l=b.get(d);this.GenerateRealtimeNotification(d,l)}var c=RehearsalSummaryCollector.GetRehearsalSummaryControlInstance();if(c==null)return;var i=Number(g.getCurrentslideindex());if(b.has(RehearsalSettings.FillerWordsKey)){var j=[];j.push(String(b.get(RehearsalSettings.FillerWordsKey).getFeaturevalue()));c.AddFillers(j)}b.has(RehearsalSettings.WordsPerMinuteKey)&&c.AddPace(Number(b.get(RehearsalSettings.WordsPerMinuteKey).getFeaturevalue()));if(b.has(RehearsalSettings.SensitivePhrasesKey)){var h=[];h.push(String(b.get(RehearsalSettings.SensitivePhrasesKey).getFeaturevalue()));var f=[];b.has(RehearsalSettings.CorrectedSensitivePhrasesKey)&&f.push(String(b.get(RehearsalSettings.CorrectedSensitivePhrasesKey).getFeaturevalue()));c.AddSensitivePhrases(h,f)}if(b.has(RehearsalSettings.OriginalityKey))c.AddOriginalityScore(i,Number(b.get(RehearsalSettings.OriginalityKey).getFeaturevalue()));else c.AddOriginalityScore(i,1);if(b.has(RehearsalSettings.OriginalityOverlapThreshold))RehearsalSettings.OriginalityOverlapThreshold=Number(b.get(RehearsalSettings.OriginalityThresholdKey).getFeaturevalue())};a.prototype.GetRehearsalState=function(){return this.m_rehearsalState};a.prototype.PlayRehearsalAlertSound=function(){this.m_rehearsalAlertAudio!=null&&this.m_rehearsalAlertAudio.play()};a.prototype.DisposeRehearsalInternal=function(){this.RemoveRehearsalDiv();this.RemoveRehearsalDragDropContainer();this.m_rehearsalPresentationTimerId!==0&&clearInterval(this.m_rehearsalPresentationTimerId);if(this.m_timerForClearingRehearsalDashboard){clearTimeout(this.m_timerForClearingRehearsalDashboard);this.m_timerForClearingRehearsalDashboard=null}this.m_rehearsalDragDropPositionTracker&&this.m_rehearsalDragDropPositionTracker.removeEventHandlers()};a.prototype.StartRealTimeTrackers=function(){if(this.m_rehearsalDiv!=null&&this.m_rehearsalWelcomeDiv!=null&&this.m_rehearsalInteractivePanelDiv!=null&&this.m_rehearsalRealtimeLabelSpan!=null&&this.m_rehearsalTopBarDiv!=null){this.m_rehearsalWelcomeDiv.style.display="none";this.m_rehearsalTopBarDiv.style.display="none";this.m_rehearsalInteractivePanelDiv.style.display="inline-block";this.m_rehearsalDiv.style.transition=RehearsalSettings.RehearsalDashboardMinimizeTransition;this.m_rehearsalDiv.style.height=RehearsalSettings.RehearsalDashboardMinimizedHeight;this.m_rehearsalPresentationTimerId!==0&&clearInterval(this.m_rehearsalPresentationTimerId);this.m_rehearsalPresentationTimerId=setInterval(updateTimer,RehearsalSettings.UpdateTimerIntervalInMS);this.m_presentationTimeInSeconds=0;this.m_rehearsalState=RehearsalState.Started}};a.prototype.RemoveRehearsalDiv=function(){if(this.m_rehearsalDiv&&this.m_rehearsalDiv.parentNode){this.m_rehearsalDiv.parentNode.removeChild(this.m_rehearsalDiv);this.m_rehearsalDiv=null}};a.prototype.RemoveRehearsalDragDropContainer=function(){if(this.m_rehearsalDragDropContainer&&this.m_rehearsalDragDropContainer.parentNode){this.m_rehearsalDragDropContainer.parentNode.removeChild(this.m_rehearsalDragDropContainer);this.m_rehearsalDragDropContainer=null}};a.GenerateId=function(){var a="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",b=a.replace(/[xy]/g,function(b){var a=Math.random()*16|0,c=b==="x"?a:a&3|8;return c.toString(16)});return b};a.prototype.GetDisabledRealtimeFeatureSet=function(c){var d=this,b=JSON.parse(c),a=b.DisabledRehearsalRealtimeFeaturesStr;this.m_disabledRealtimeFeatures={};a.split(",").forEach(function(a){if(a.length>0)d.m_disabledRealtimeFeatures[a.toLowerCase()]=true})};a.prototype.InitializeRehearsalInternal=function(b,e,f,d){this.InitializeRehearsalSessionTelemetry();a.CreateRehearsalDashboard();this.m_rehearsalState=RehearsalState.NotStarted;this.m_currentlyShownFeatureName="";this.GetDisabledRealtimeFeatureSet(d);this.m_sessionTelemetry.FRehearsalIdProvidedOnInitialization=b!=null;this.m_rehearsalId=b==null?a.GenerateId():b;this.m_sessionTelemetry.RehearsalId=this.m_rehearsalId;SessionLogger.traceTag(41726050,logCategory.PptSession,logLevel.Info,"Rehearsal::InitializeRehearsalInternal Rehearsal session initialized. RehearsalID: "+this.m_rehearsalId);this.m_rehearsalRealtimeLabelSpan=document.getElementById("ppt-RehearsalTrackerLabel-realtime");this.m_rehearsalDetectedValueWithMessageDiv=document.getElementById("ppt-RehearsalTrackerDiv-detectedValueWithMessage");this.m_rehearsalDetectedValueWithMessageValueSpan=document.getElementById("ppt-RehearsalTrackerValue-detectedValueWithMessage-value");this.m_rehearsalDetectedValueWithMessageMessageSpan=document.getElementById("ppt-RehearsalTrackerValue-detectedValueWithMessage-message");this.m_rehearsalSingleMessageDiv=document.getElementById("ppt-RehearsalTrackerDiv-singleMessage");this.m_rehearsalSingleMessageSpan=document.getElementById("ppt-RehearsalTrackerValue-singleMessage-message");this.m_rehearsalGaugeWithMessageDiv=document.getElementById("ppt-RehearsalTrackerDiv-gaugeWithMessage");this.m_rehearsalGaugeWithMessageLabel=document.getElementById("ppt-RehearsalTrackerValue-gaugeWithMessage-message");this.m_rehearsalGaugeWithMessageTicker=document.getElementById("ppt-Rehearsal-gaugeTicker");this.m_rehearsalWelcomeDiv=document.getElementById("ppt-RehearsalTrackerDiv-welcome");this.m_rehearsalInteractivePanelDiv=document.getElementById("ppt-RehearsalTrackerDiv-interactivePanel");this.m_rehearsalDiv=document.getElementById("ppt-RehearsalDiv");this.m_rehearsalActiveTrackerDiv=null;this.m_rehearsalGetStartedButton=document.getElementById("ppt-RehearsalTrackerDiv-welcome-getStartedButton");this.m_rehearsalPauseButtonDiv=document.getElementById("ppt-Rehearsal-pauseButton");this.m_rehearsalPlayButtonDiv=document.getElementById("ppt-Rehearsal-playButton");this.m_rehearsalPresentationTimerDiv=document.getElementById("ppt-RehearsalTrackerDiv-presentationTimer");this.m_rehearsalSlideTrackerDiv=document.getElementById("ppt-RehearsalTrackerDiv-slideCountTracker");this.m_slideCount=f;this.UpdateSlideTracker(e);this.m_rehearsalTopBarDiv=document.getElementById("ppt-RehearsalDiv-topBar");this.m_timerForClearingRehearsalDashboard=null;this.m_timerForShowActiveRehearsalTracker=null;this.m_rehearsalAlertAudio=new Audio;this.m_rehearsalAlertAudio.src=RehearsalSettings.RehearsalAlertSoundFilePath;this.m_rehearsalDiv!=null&&this.m_rehearsalDiv.appendChild(this.m_rehearsalAlertAudio);this.m_rehearsalDragDropContainer=document.getElementById("ppt-RehearsalDiv-dragDropContainer");if(this.m_rehearsalDiv&&this.m_rehearsalDragDropContainer){var c=this.m_rehearsalDiv.style.transition;this.m_rehearsalDragDropPositionTracker=new DragDropPositionTracker(this.m_rehearsalDiv,c?c:"",this.m_rehearsalDragDropContainer);this.m_rehearsalDragDropPositionTracker.addEventHandlers()}if(this.m_rehearsalDiv!=null)this.m_rehearsalDiv.style.display="initial"};a.GenerateRealTimeLabel=function(b,c){var a=document.createElement("div");a.id=c;a.style.fontSize="14px";a.style.fontWeight="600";a.style.lineHeight="1.43";a.style.color=RehearsalSettings.ColorWhite;a.style.position="relative";a.style.fontFamily="Segoe UI, sans-serif, mono-serif, proportional-serif, 'mono sans serif', casual, cursive, 'small caps'";a.style.width="95%";a.style.height="20px";a.style.display="inline-block";a.innerText=b;return a};a.GeneratePlayButton=function(){var a=document.createElement("img");a.id="ppt-Rehearsal-playButton";a.src=RehearsalSettings.RehearsalPlayButtonFilePath;a.style.display="inline-block";a.style.height="auto";a.style.width="8px";a.style.textAlign="center";a.setAttribute("focusable","true");a.setAttribute("aria-label","Play");a.setAttribute("role","button");a.tabIndex=RehearsalSettings.RehearsalKeyboardFocusTabIndex;a.onclick=togglePause;a.onkeypress=togglePause;return a};a.GeneratePauseButton=function(){var a=document.createElement("img");a.id="ppt-Rehearsal-pauseButton";a.src=RehearsalSettings.RehearsalPauseButtonFilePath;a.style.width="auto";a.style.height="11px";a.style.display="inline-block";a.style.textAlign="center";a.setAttribute("focusable","true");a.setAttribute("aria-label","Pause");a.setAttribute("role","button");a.tabIndex=RehearsalSettings.RehearsalKeyboardFocusTabIndex;a.onclick=togglePause;a.onkeypress=togglePause;return a};a.GeneratePlayPauseButton=function(){var b=document.createElement("div");b.id="ppt-RehearsalTrackerDiv-playPauseContainer";b.style.height="16px";b.style.width="16px";b.style.marginRight="10px";b.style.display="inline-block";b.style.textAlign="center";var d=a.GeneratePauseButton(),c=a.GeneratePlayButton();c.style.display="none";b.appendChild(d);b.appendChild(c);return b};a.GeneratePresentationTimer=function(){var a=document.createElement("div");a.id="ppt-RehearsalTrackerDiv-presentationTimer";a.style.height="100%";a.style.width="100px";a.style.fontSize="14px";a.style.display="inline-block";a.style.fontFamily="Segoe UI, sans-serif, mono-serif, proportional-serif, 'mono sans serif', casual, cursive, 'small caps'";a.style.color=RehearsalSettings.ColorWhite;a.innerHTML="00:00:00";return a};a.GenerateSlideCountTracker=function(){var a=document.createElement("div");a.id="ppt-RehearsalTrackerDiv-slideCountTracker";a.style.height="100%";a.style.width="80px";a.style.fontSize="14px";a.style.display="inline-block";a.style.textAlign="right";a.style.fontFamily="Segoe UI, sans-serif, mono-serif, proportional-serif, 'mono sans serif', casual, cursive, 'small caps'";a.style.color=RehearsalSettings.ColorWhite;a.innerHTML="";return a};a.GenerateRehearsalInteractivePanel=function(){var b=document.createElement("div");b.id="ppt-RehearsalTrackerDiv-interactivePanel";b.style.position="absolute";b.style.bottom="8px";b.style.width=RehearsalSettings.RehearsalDashboardWidth;b.style.height="16px";b.style.display="none";var e=a.GeneratePlayPauseButton(),c=a.GeneratePresentationTimer(),d=a.GenerateSlideCountTracker();b.appendChild(e);b.appendChild(c);b.appendChild(d);return b};a.GenerateDetectedValueParentDiv=function(b){var a=document.createElement("div");a.id=b+"-parent";a.style.display="inline-block";a.style.textAlign="center";a.style.width="100%";a.style.height="118px";a.style.position="relative";return a};a.GenerateMessageDiv=function(b){var a=document.createElement("div");a.id=b;a.style.height="auto";a.style.width="100%";a.style.textAlign="center";a.style.color=RehearsalSettings.ColorWhite;a.style.fontFamily="Segoe UI, sans-serif, mono-serif, proportional-serif, 'mono sans serif', casual, cursive, 'small caps'";a.style.fontSize="14px";a.innerText="";return a};a.GenerateTrackerValueDiv=function(){var a=document.createElement("div");a.style.height="auto";a.style.width="100%";a.style.position="absolute";a.style.textAlign="center";a.style.top="50%";a.style.transform="translateY(-50%)";return a};a.GenerateFirstRunWelcomeValueDiv=function(){var a=document.createElement("div");a.style.height="auto";a.style.width="100%";a.style.position="absolute";a.style.textAlign="center";return a};a.GenerateWelcomeImage=function(){var a=document.createElement("img");a.src=RehearsalSettings.RehearsalWelcomeScreenGraphicFilePath;a.style.height="auto";a.style.width="100%";a.style.textAlign="center";a.style.marginTop="19px";a.alt="Laptop running Presenter Coach";return a};a.GenerateDetectedValueDiv=function(b){var a=document.createElement("div");a.id=b;a.innerText="";a.style.height="auto";a.style.width="100%";a.style.fontFamily="Segoe UI, sans-serif, mono-serif, proportional-serif, 'mono sans serif', casual, cursive, 'small caps'";a.style.fontSize="20px";a.style.fontWeight="600";a.style.lineHeight="1.2";a.style.marginBottom="4px";a.style.color=RehearsalSettings.ColorWhite;a.style.textAlign="center";return a};a.GenerateDetectedValueWithMessageTemplateDiv=function(){var b=a.GenerateTrackerValueDiv(),c=a.GenerateDetectedValueDiv("ppt-RehearsalTrackerValue-detectedValueWithMessage-value"),d=a.GenerateMessageDiv("ppt-RehearsalTrackerValue-detectedValueWithMessage-message");b.appendChild(c);b.appendChild(d);return b};a.GenerateSingleMessageTemplateDiv=function(){var b=a.GenerateTrackerValueDiv(),c=a.GenerateMessageDiv("ppt-RehearsalTrackerValue-singleMessage-message");b.appendChild(c);return b};a.GenerateGaugeWithMessageTemplateDiv=function(){var c=a.GenerateTrackerValueDiv(),d=a.GenerateGauge(),b=document.createElement("div");b.id="ppt-RehearsalTrackerValue-gaugeWithMessage-message";b.innerText="";b.style.height="28px";b.style.width="100%";b.style.fontFamily="Segoe UI, sans-serif, mono-serif, proportional-serif, 'mono sans serif', casual, cursive, 'small caps'";b.style.fontSize="14px";b.style.color=RehearsalSettings.ColorWhite;b.style.textAlign="center";c.appendChild(d);c.appendChild(b);return c};a.GenerateGaugeTicker=function(){var c=document.createElement("div");c.className="gaugeTicker";var a=document.createElement("div");a.id="ppt-Rehearsal-gaugeTicker";a.className="gaugePointer";a.style.width="0";a.style.height="0";a.style.borderLeft="4px solid transparent";a.style.borderRight="4px solid transparent";a.style.borderBottom="30px solid #ffffff";a.style.transformOrigin="center 100% 0px";a.style.transform="rotate(-90deg)";a.style.transition="all .75s linear";var b=document.createElement("div");b.className="gaugePivot";b.style.width="8px";b.style.height="8px";b.style.borderRadius="50%";b.style.backgroundColor=RehearsalSettings.ColorWhite;c.appendChild(a);c.appendChild(b);return c};a.GenerateGauge=function(){var f=document.createElement("div");f.style.width="100%";f.setAttribute("aria-hidden","true");var d=document.createElement("div");d.className="gaugeContainer";var g=document.createElement("canvas");g.className="gaugeOuter";var c=g.getContext("2d");if(c!=null){c.lineWidth=12;c.strokeStyle="#ffffff";c.beginPath();c.arc(150,150,75,Math.PI,0);c.stroke()}var e=document.createElement("canvas");e.className="gaugeOuter";var b=e.getContext("2d");if(b!=null){b.lineWidth=12;b.strokeStyle="rgba( 140, 189, 24, 1)";b.beginPath();b.arc(150,150,75,-.7*Math.PI,-.3*Math.PI);b.stroke()}e.style.zIndex="1";var h=a.GenerateGaugeTicker();d.appendChild(g);d.appendChild(e);d.appendChild(h);f.appendChild(d);return f};a.GenerateTrackerDiv=function(b){var a=document.createElement("div");a.id=b;a.style.width="100%";a.style.display="none";a.style.height="118px";a.style.textAlign="center";a.style.position="relative";return a};a.GenerateRehearsalTrackerDiv=function(b){if(b==RehearsalTemplate.DetectedValueWithMessage){var e=a.GenerateTrackerDiv("ppt-RehearsalTrackerDiv-detectedValueWithMessage"),c=a.GenerateDetectedValueParentDiv("ppt-RehearsalTrackerValue-detectedValueWithMessage"),i=a.GenerateDetectedValueWithMessageTemplateDiv();c.appendChild(i);e.appendChild(c);return e}else if(b==RehearsalTemplate.GaugeWithMessage){var h=a.GenerateTrackerDiv("ppt-RehearsalTrackerDiv-gaugeWithMessage"),g=a.GenerateDetectedValueParentDiv("ppt-RehearsalTrackerValue-gaugeWithMessage"),k=a.GenerateGaugeWithMessageTemplateDiv();g.appendChild(k);h.appendChild(g);return h}else if(b==RehearsalTemplate.SingleMessage){var f=a.GenerateTrackerDiv("ppt-RehearsalTrackerDiv-singleMessage"),d=a.GenerateDetectedValueParentDiv("ppt-RehearsalTrackerValue-singleMessage"),j=a.GenerateSingleMessageTemplateDiv();d.appendChild(j);f.appendChild(d);return f}else{SessionLogger.traceTag(42259012,logCategory.PptSession,logLevel.Error,"Rehearsal::GenerateRehearsalTrackerDiv Unhandled RehearsalTracker: "+b);return a.GenerateTrackerDiv("ppt-RehearsalTrackerDiv-unknownDiv")}};a.GenerateWelcomeText=function(){var a=document.createElement("div");a.style.display="inline-block";a.style.textAlign="center";a.style.width="100%";a.style.height="auto";a.style.position="relative";a.style.fontFamily="Segoe UI, sans-serif, mono-serif, proportional-serif, 'mono sans serif', casual, cursive, 'small caps'";a.style.color=RehearsalSettings.ColorWhite;a.style.lineHeight="1.43";a.style.fontSize="14px";a.setAttribute("focusable","true");a.tabIndex=0;var b=RehearsalSettings.FRehearsalAlreadyTriggeredDuringSession?RehearsalSettings.RehearsalGenericWelcomeScreenText:RehearsalSettings.RehearsalFirstRunWelcomeScreenText;a.innerText=b;a.setAttribute("aria-label",b);a.setAttribute("role","text");a.setAttribute("aria-role","text");return a};a.GenerateWelcomeTitle=function(){var a=document.createElement("div");a.style.display="inline-block";a.style.textAlign="center";a.style.width="100%";a.style.height="40px";a.style.position="relative";a.style.fontFamily="Segoe UI, sans-serif, mono-serif, proportional-serif, 'mono sans serif', casual, cursive, 'small caps'";a.style.fontWeight="600";a.style.color=RehearsalSettings.ColorWhite;a.style.lineHeight="1.43";a.style.fontSize="14px";a.style.marginTop="27px";a.style.marginBottom="9px";a.setAttribute("focusable","true");a.tabIndex=0;a.innerText=RehearsalSettings.RehearsalWelcomeScreenTitle;a.setAttribute("aria-label",RehearsalSettings.RehearsalWelcomeScreenTitle);a.setAttribute("role","heading");a.setAttribute("aria-role","heading");return a};a.GenerateGetStartedButton=function(){var a=document.createElement("button");a.id="ppt-RehearsalTrackerDiv-welcome-getStartedButton";a.className="getStartedButton";a.onmousedown=onMouseDownClickedGetStarted;a.onclick=userClickedGetStarted;a.setAttribute("focusable","true");a.tabIndex=RehearsalSettings.RehearsalKeyboardFocusTabIndex;a.textContent=RehearsalSettings.RehearsalGetStartedButtonLabel;a.style.color=RehearsalSettings.ColorWhite;a.style.fontSize="14px";a.style.fontWeight="600";a.style.fontFamily="Segoe UI, sans-serif, mono-serif, proportional-serif, 'mono sans serif', casual, cursive, 'small caps'";return a};a.GenerateWelcomeScreen=function(){var b=document.createElement("div");b.id="ppt-RehearsalTrackerDiv-welcome";b.style.width="100%";b.style.display="inline-block";b.style.height=RehearsalSettings.FRehearsalAlreadyTriggeredDuringSession?RehearsalSettings.RehearsalDashboardGenericWelcomeDivHeight:RehearsalSettings.RehearsalDashboardFirstRunWelcomeDivHeight;b.style.textAlign="center";b.style.position="relative";var c=RehearsalSettings.FRehearsalAlreadyTriggeredDuringSession?a.GenerateTrackerValueDiv():a.GenerateFirstRunWelcomeValueDiv();if(!RehearsalSettings.FRehearsalAlreadyTriggeredDuringSession){var e=a.GenerateWelcomeImage(),f=a.GenerateWelcomeTitle();c.appendChild(e);c.appendChild(f)}var g=a.GenerateWelcomeText(),d=a.GenerateGetStartedButton();c.appendChild(g);c.appendChild(d);b.appendChild(c);return b};a.GenerateRehearsalTopBar=function(){var b=document.createElement("div");b.id="ppt-RehearsalDiv-topBar";b.style.lineHeight="1.43";b.style.position="relative";b.style.width="100%";b.style.height="20px";b.style.display="inline-block";var c=a.GenerateRealTimeLabel("Welcome","ppt-RehearsalTrackerLabel-realtime");b.appendChild(c);return b};a.GenerateRehearsalDragDropContainer=function(){var a=document.createElement("div");a.id="ppt-RehearsalDiv-dragDropContainer";a.style.position="absolute";a.style.top="0";a.style.left="0";a.style.width="100vw";a.style.height="100vh";a.style.display="none";return a};a.CreateRehearsalDashboard=function(){var m=document.getElementById("ppt-RehearsalDiv");if(m){SessionLogger.traceTag(41726051,logCategory.PptSession,logLevel.Error,"Rehearsal::CreateRehearsalDashboard already created.");return}var e=Date.now(),b=document.createElement("div");b.id="ppt-RehearsalDiv";b.style.width=RehearsalSettings.RehearsalDashboardWidth;b.style.height=RehearsalSettings.FRehearsalAlreadyTriggeredDuringSession?RehearsalSettings.RehearsalDashboardMaximizedHeight:RehearsalSettings.RehearsalDashboardFirstRunMaximizedHeight;b.style.background="rgba( 32, 31, 30, 0.92 )";b.style.borderRadius="4px";b.style.right="5%";b.style.bottom="10%";b.style.position="absolute";b.style.userSelect="none";b.style.paddingTop="8px";b.style.paddingBottom="8px";b.style.paddingLeft="13px";b.style.paddingRight="13px";b.style.transition=RehearsalSettings.RehearsalDashboardMaximizeTransition;b.setAttribute("role","alert");b.setAttribute("aria-role","alert");b.setAttribute("aria-live","assertive");b.setAttribute("aria-label","Rehearse with Coach Dashboard");var c=document.createElement("div");c.id="ppt-RehearsalDiv-container";c.style.width="100%";c.style.height="auto";var k=a.GenerateRehearsalTopBar();c.appendChild(k);var l=a.GenerateWelcomeScreen();c.appendChild(l);var f=a.GenerateRehearsalTrackerDiv(RehearsalTemplate.DetectedValueWithMessage),h=a.GenerateRehearsalTrackerDiv(RehearsalTemplate.GaugeWithMessage),i=a.GenerateRehearsalTrackerDiv(RehearsalTemplate.SingleMessage);c.appendChild(f);c.appendChild(h);c.appendChild(i);var j=a.GenerateRehearsalInteractivePanel();b.appendChild(c);b.appendChild(j);var g=a.GenerateRehearsalDragDropContainer();document.body.appendChild(g);document.body.appendChild(b);var d=a.GetInstance();if(d!=null)d.m_sessionTelemetry.CreateDashboardTimeInMS=Date.now()-e;b.addEventListener("contextmenu",disableContextMenu)};a.s_instance=null;return a}(),SensitivePhrasesData=function(){function a(){}return a}(),CorrectedSensitivePhrasesData=function(){function a(){}return a}(),FillerData=function(){function a(){}return a}(),PaceData=function(){function a(){}return a}(),RehearsalSummaryData=function(){function a(){}return a}(),RehearsalSummaryCollector=function(){function a(){this.m_startTime=-1;this.m_stopTime=-1;this.m_paceSamplingInverseRate=1;this.m_paceSamplingPortion=0;this.m_paceOverTime=[];this.m_fillers={};this.m_sensitivePhrases={};this.m_originalityScores={}}a.GetInstance=function(){if(!this.s_instance)this.s_instance=new a;return this.s_instance};a.GetRehearsalSummaryStateInstance=function(){return this.GetInstance()};a.GetRehearsalSummaryControlInstance=function(){return this.GetInstance()};a.DisposeInstance=function(){this.s_instance=null};a.prototype.Reset=function(){this.m_startTime=this.m_stopTime=-1;this.m_paceSamplingInverseRate=1;this.m_paceSamplingPortion=0;this.m_paceOverTime=[];this.m_fillers={};this.m_sensitivePhrases={}};a.prototype.EnsureIsStarted=function(){this.m_startTime==-1&&this.StartRehearsal()};a.prototype.StartRehearsal=function(){this.m_stopTime!=-1&&this.Reset();this.m_startTime=Date.now().valueOf()};a.prototype.StopRehearsal=function(){if(this.m_stopTime==-1)this.m_stopTime=Date.now().valueOf()};a.prototype.AddPace=function(d){this.EnsureIsStarted();this.m_paceSamplingPortion%this.m_paceSamplingInverseRate==0&&this.m_paceOverTime.push({pace:d,timePoint:Date.now().valueOf()-this.m_startTime});this.m_paceSamplingPortion++;if(this.m_paceOverTime.length>=a.MaxPaceTimePoints){for(var c=[],b=0;b<this.m_paceOverTime.length;b++)b%2==0&&c.push(this.m_paceOverTime[b]);this.m_paceOverTime=c;this.m_paceSamplingInverseRate*=2;this.m_paceSamplingPortion=0}};a.AddCountsToHashMap=function(a,b){if(b.length==0)return;b.forEach(function(b){if(b.length==0)return;if(a[b]==undefined)a[b]=0;a[b]++})};a.prototype.AddFillers=function(b){this.EnsureIsStarted();a.AddCountsToHashMap(this.m_fillers,b)};a.prototype.AddSensitivePhrases=function(d,a){var b=this;this.EnsureIsStarted();var c=a!=undefined&&a.length>0;if(c&&a.length!=d.length){c=false;SessionLogger.traceTag(42329820,logCategory.PptSession,logLevel.Error,"RehearsalSummary::AddSensitivePhrases Length of corrected phrases does not match length of phrases")}d.forEach(function(d,e){if(d.length==0)return;if(b.m_sensitivePhrases[d]==undefined)b.m_sensitivePhrases[d]={count:0,correction:""};b.m_sensitivePhrases[d].count++;b.m_sensitivePhrases[d].correction=c?a[e]:""})};a.prototype.AddOriginalityScore=function(a,b){this.EnsureIsStarted();if(this.m_originalityScores[a]==undefined||this.m_originalityScores[a]>b)this.m_originalityScores[a]=b};a.prototype.GetTimeSpent=function(){var c=Date.now().valueOf(),a=this.m_startTime==-1?c:this.m_startTime,b=this.m_stopTime==-1?c:this.m_stopTime;if(a>b)a=b;return Math.round((b-a)/1e3)};a.prototype.GetSlidesRehearsed=function(){return Object.keys(this.m_originalityScores).map(function(a){return Number(a)})};a.prototype.GetAveragePace=function(){if(this.m_paceOverTime.length>0){var a=0;this.m_paceOverTime.forEach(function(b){a+=b.pace});return Math.round(a/this.m_paceOverTime.length)}return 0};a.prototype.GetPaceOverTime=function(){var a=[];this.m_paceOverTime.forEach(function(b){a.push({pace:Math.round(b.pace),timePoint:Math.round(b.timePoint/1e3)})});return a};a.prototype.GetFillers=function(){var b=this,a=[];Object.keys(this.m_fillers).forEach(function(c){a.push({word:c,count:Number(b.m_fillers[c])})});a.sort(function(b,a){return a.count-b.count});return a};a.prototype.GetSortedSensitivePhrases=function(a){var c=this;if(a===void 0)a=false;var b=[];Object.keys(this.m_sensitivePhrases).forEach(function(d){b.push({phraseData:{phrase:d,count:Number(c.m_sensitivePhrases[d].count)},correction:a?c.m_sensitivePhrases[d].correction||"":""})});b.sort(function(b,a){return a.phraseData.count-b.phraseData.count});return b};a.prototype.GetOriginalityProblemSlides=function(){var b=this,a=[];Object.keys(this.m_originalityScores).forEach(function(c){b.m_originalityScores[Number(c)]<RehearsalSettings.OriginalityOverlapThreshold&&a.push(Number(c))});return a};a.prototype.GetRehearsalSummary=function(){if(this.m_startTime==-1){SessionLogger.traceTag(41760841,logCategory.PptSession,logLevel.Error,"RehearsalSummary::GetRehearsalSummary returning null as Rehearsal was not started");return null}var a=this.GetSortedSensitivePhrases(true),b={fillers:this.GetFillers(),sensitivePhrases:a.map(function(a){return a.phraseData}),sensitivePhrasesCorrected:a.map(function(a){return a.correction}),originalityProblemSlides:this.GetOriginalityProblemSlides(),timeSpent:this.GetTimeSpent(),averagePace:this.GetAveragePace(),paceOverTime:this.GetPaceOverTime(),slidesRehearsed:this.GetSlidesRehearsed().length},c=JSON.stringify(b);SessionLogger.traceTag(41760842,logCategory.PptSession,logLevel.Info,"RehearsalSummary::GetRehearsalSummary returning"+c);return b};a.s_instance=null;a.MaxPaceTimePoints=64;return a}(),SessionLogger=PowerPointOnline.Telemetry.SessionLogger,UlsSessionLogger=PowerPointOnline.Telemetry.UlsSessionLogger;function PostMessageUpward(a){window.parent.postMessage(JSON.stringify(a),"*")}var OnGetUserMediaSuccessEntryPoint;(function(a){a[a.None=0]="None";a[a.OnLoadCustomEndpointRequest=1]="OnLoadCustomEndpointRequest";a[a.OnErrorCustomEndpointRequest=2]="OnErrorCustomEndpointRequest";a[a.OnTimeoutCustomEndpointRequest=3]="OnTimeoutCustomEndpointRequest";a[a.CustomEndpointNotEnabled=4]="CustomEndpointNotEnabled";a[a.InvalidDocId=5]="InvalidDocId"})(OnGetUserMediaSuccessEntryPoint||(OnGetUserMediaSuccessEntryPoint={}));var TranscriptionEntryPoint;(function(a){a[a.None=0]="None";a[a.SingleLineRibbon=1]="SingleLineRibbon";a[a.MultipleLineRibbon=2]="MultipleLineRibbon";a[a.SlideShowToolbar=3]="SlideShowToolbar";a[a.SlideShowKeyboardShortcut=4]="SlideShowKeyboardShortcut";a[a.LiveBroadcast=5]="LiveBroadcast"})(TranscriptionEntryPoint||(TranscriptionEntryPoint={}));var TelemetryFieldNames=function(){function a(){}a.AudioFactorCalculationDurationMS="AudioFactorCalculationDurationMS";a.BufferSize="BufferSize";a.CreateTranscribeContainerEndTimeMS="CreateTranscribeContainerEndTimeMS";a.CreateTranscribeContainerStartTimeMS="CreateTranscribeContainerStartTimeMS";a.CustomEndpointEnabled="CustomEndpointEnabled";a.CustomEndpointRequestCorrelationID="CustomEndpointRequestCorrelationID";a.CurrentTimestampMS="CurrentTimestampMS";a.DataLoggingTimeInterval="DataLoggingTimeInterval";a.Endpoint="Endpoint";a.FatalErrors="FatalErrors";a.FirstMessageLatencyMS="FirstMessageLatencyMS";a.InitializeWebSocketEndTimeMS="InitializeWebSocketEndTimeMS";a.InitializeWebSocketStartTimeMS="InitializeWebSocketStartTimeMS";a.LatencyTableDeletedCount="LatencyTableDeletedCount";a.MaxFinalMessageLatencyMS="MaxFinalMessageLatencyMS";a.MaxPartialMessageLatencyMS="MaxPartialMessageLatencyMS";a.MessageLatencyCalculationTimeMS="MessageLatencyCalculationTimeMS";a.MinFinalMessageLatencyMS="MinFinalMessageLatencyMS";a.MinPartialMessageLatencyMS="MinPartialMessageLatencyMS";a.NonFatalErrors="NonFatalErrors";a.OnGetUserMediaSuccessEntryPoint="OnGetUserMediaSuccessEntryPoint";a.RealTimeFactorLowerThreshold="RealTimeFactorLowerThreshold";a.RealTimeFactorUpperThreshold="RealTimeFactorUpperThreshold";a.RequestCustomEndpointEndTimeMS="RequestCustomEndpointEndTimeMS";a.RequestCustomEndpointFailedEndTimeMS="RequestCustomEndpointFailedEndTimeMS";a.RequestCustomEndpointStartTimeMS="RequestCustomEndpointStartTimeMS";a.RequestCustomEndpointTimedOutEndTimeMS="RequestCustomEndpointTimedOutEndTimeMS";a.SendFirstMessageTime="SendFirstMessageTime";a.ServiceRequestTranslationLanguages="ServiceRequestTranslationLanguages";a.SpeechLanguage="SpeechLanguage";a.TotalAudioFactorOutsideOfThresholdCount="TotalAudioFactorOutsideOfThresholdCount";a.TotalEntriesInLatencyTable="TotalEntriesInLatencyTable";a.TotalFinalMessagesCount="TotalFinalMessagesCount";a.TotalFinalMessageLatency="TotalFinalMessageLatency";a.TotalHighLatencyPartialMessagesCount="TotalHighLatencyPartialMessagesCount";a.TotalHighLatencyFinalMessagesCount="TotalHighLatencyFinalMessagesCount";a.TotalMessageCorrelationIDNotFoundCount="TotalMessageCorrelationIDNotFoundCount";a.TotalPartialMessageLatency="TotalPartialMessageLatency";a.TotalPartialMessagesCount="TotalPartialMessagesCount";a.TotalTranscriptOutsideOfThresholdCount="TotalTranscriptOutsideOfThresholdCount";a.TranscriberID="TranscriberID";a.TranscriptionEntryPoint="TranscriptionEntryPoint";a.TranscriptionEntryPointCalled="TranscriptionEntryPointCalled";a.TranscriptionStartTime="TranscriptionStartTime";a.TranscriptionEndTime="TranscriptionEndTime";a.TranslationLanguage="TranslationLanguage";a.WebSocketClosedTimestamp="WebSocketClosedTimestamp";a.WebSocketConnectionDurationMS="WebSocketConnectionDurationMS";a.WebSocketCreateTimestamp="WebSocketCreateTimestamp";a.WebSocketCustomEndpoint="WebSocketCustomEndpoint";a.WebSocketOpenedTimestamp="WebSocketOpenedTimestamp";a.WebSocketRetryAttempts="WebSocketRetryAttempts";a.WebSocketRetryReason="WebSocketRetryReason";a.FEnableContentlogging="FEnableContentlogging";a.SpeechMode="SpeechMode";a.TranscriberPosition="TranscriberPosition";a.TranscriberDisposeDuration="TranscriberDisposeDuration";a.TotalNetworkErrorMessageCount="TotalNetworkErrorMessageCount";a.TotalNetworkWarningMessageCount="TotalNetworkWarningMessageCount";a.TotalQualityErrorMessageCount="TotalQualityErrorMessageCount";a.TotalQualityWarningMessageCount="TotalQualityWarningMessageCount";return a}(),TelemetryErrorFieldNames=function(){function a(){}a.CustomEndpointClientError="CustomEndpointClientError";a.CustomEndpointClientFailureReason="CustomEndpointClientFailureReason";a.CustomEndpointServerError="CustomEndpointServerError";a.CustomEndpointServerErrorCode="CustomEndpointServerErrorCode";a.CustomEndpointServerFailureReason="CustomEndpointServerFailureReason";a.ErrorNoAudioSend="ErrorNoAudioSend";a.ErrorStatus="ErrorStatus";a.InvalidDocId="InvalidDocId";a.MessageErrorCode="MessageErrorCode";a.TranscriptErrorCode="TranscriptErrorCode";a.WebSocketDisconnected="WebSocketDisconnected";a.WebSocketErrorCode="WebSocketErrorCode";a.WebSocketRetryConnectionFailed="WebSocketRetryConnectionFailed";a.InitializeAudioContextFailed="InitializeAudioContextFailed";a.InitializeTranscriberSessionFailed="InitializeTranscriberSessionFailed";a.GetUserMediaFailed="GetUserMediaFailed";a.ReadSettingsFailed="ReadSettingsFailed";a.QualityMessageShortcodeInvalid="QualityMessageShortcodeInvalid";a.DisplayQualityStatusException="DisplayQualityStatusException";a.TemporaryDisableSubtitleDueNetworkError="TemporaryDisableSubtitleDueNetworkError";a.LossInternetConnection="LossInternetConnection";return a}(),TranscriberSettings=function(){function a(){}a.WacUserSessionId="";a.WacUserDatacenterCluster="";a.EntryPoint=TranscriptionEntryPoint.None;a.StartTime=0;a.RetryEnabled=false;a.MaxAllowedFragmentLatencyMS=5e3;a.MaxAllowedFinalFragmentLatencyMS=2e4;a.DynamicBufferEnabled=false;a.DefaultBufferSize=8192;a.ResetTranscriptionTextIntervalMS=1e4;a.ResetQualityDetectionIntervalMS=3e4;a.DataLoggingIntervalMS=3e4;a.RealTimeFactorLowerThreshold=0;a.RealTimeFactorUpperThreshold=999;a.IsLogEachTranscriptMessage=false;a.MaxAllowedRetryCountPerSession=15;a.FragmentLatencyWarnWindow=6;a.FragmentLatencyErrorWindow=3;a.AccessibilityEnabledAriaLiveState="";a.TranscriberPosition="BelowSlide";a.CustomEndpointRequestTimeoutInMs=1e4;a.RTLLanguages="ar,he,fa,ur";a.IsReactiveUXEnabled=false;a.fSupportSpeechResponseMessage=false;a.NoInternetConnectionInMs=12e4;a.TranslationLanguagesForLive="";a.HideUIWhenSwitchingToLiveBroadcastingMode=false;a.LivePraugueSessionInfo="";a.HeartbeatInterval=3e3;a.RoundtripLatencyWarnThreshold=100;a.RoundtripLatencyErrorThreshold=500;a.FragmentLatencyWarnThreshold=5e3;a.FragmentLatencyErrorThreshold=1e4;a.AudioSendingCountIntervalMS=6e5;a.TranscriberShowListeningDetectionTextInMS=12e4;a.IsStartRehearsal=false;a.SlideCount=0;a.StartingSlideIndex=0;return a}(),TranscriberResourceString=function(){function a(){}a.AccessibilityContentString="";a.AccessibilityWindowString="";a.ErrorAudioDevice="";a.GenericRetryErrorMessage="";a.GenericNetworkErrorMessage="";a.QualityStatusStringDict={};return a}(),TranscriberDetectionSettings=function(){function a(){}a.ColorBlack="#000000";a.ColorWhite="#ffffff";a.ColorYellew="#F8E71C";a.ColorRed="#A80000";a.WarningSign="&#9888 ";return a}(),TranscriberElementIds=function(){function a(){}a.TranscriberId="ppt-Transcriber";a.ResultSpanId="ppt-TranscriberResultSpan";a.DetectionSpanId="ppt-TranscriberDetectionSpan";a.DetectionDivId="ppt-TranscriberDetectionDiv";a.AccessibilityContentSpan="ppt-TranscriberAccessibilityContentSpan";return a}(),Transcriber=function(){function a(){this.m_sessionTelemetry={};this.m_messageLatencyTable={};this.m_webSocketConnectionRetryAttempts=0;this.c_maxWebSocketRetryAttempts=5;this.c_websocketRetryInterval=5e3;this.m_webSocketTotalRetryCountInSession=0;this.c_maxEntriesInLatencyTable=1200;this.c_maxBufferSize=16384;this.m_wsTimer=0;this.m_fatalErrors=[];this.m_nonFatalErrors=[];this.m_isFirstWebSocketConnection=true;this.m_countFragmentLatencyInWarnWindow=0;this.m_countFragmentLatencyInErrorWindow=0;this.m_inNetworkQualityWarnStatus=false;this.m_inNetworkQualityErrorStatus=false;this.m_inListeningStatus=false;this.m_countRoundtripLatencyInWarnWindow=0;this.m_countRoundtripLatencyInErrorWindow=0;this.m_inRoundtripLatencyWarnStatus=false;this.m_inRoundtripLatencyErrorStatus=false;this.m_currentHeartbeatLatency=0;this.m_currentHeartbeatSendInterval=0;this.m_maxPartialMessageLatency=Number.MIN_VALUE;this.m_minPartialMessageLatency=Number.MAX_VALUE;this.m_totalPartialMessagesCount=0;this.m_totalHighLatencyPartialMessagesCount=0;this.m_totalPartialMessageLatency=0;this.m_maxFinalMessageLatency=Number.MIN_VALUE;this.m_minFinalMessageLatency=Number.MAX_VALUE;this.m_totalFinalMessagesCount=0;this.m_totalHighLatencyFinalMessagesCount=0;this.m_totalFinalMessageLatency=0;this.m_totalMessageCorrelationIDNotFoundCount=0;this.m_latencyTableDeletedCount=0;this.m_totalEntriesInLatencyTable=0;this.m_messageLatencyCalculationTime=0;this.m_audioFactorCalculationDuration=0;this.m_totalAudioFactorOutsideOfThresholdCount=0;this.m_totalAudioMessageCountInPreviousTimeInterval=0;this.m_totalAudioMessageCountInCurrentTimeInterval=0;this.m_totalAudioMessageCountInMins=0;this.m_lastSentAudioTimeUTC=Number.MAX_VALUE;this.m_currentSentAudioTimeUTC=Number.MAX_VALUE;this.m_lastAudioLogUTC=Number.MIN_VALUE;this.m_realTimeSendDataFactorCount=0;this.m_realTimeSendDataFactorSum=0;this.m_minRealTimeSendDataFactor=Number.MAX_VALUE;this.m_maxRealTimeSendDataFactor=Number.MIN_VALUE;this.m_realTimeSendDataFactorCountInTimeInterval=0;this.m_realTimeSendDataFactorSumInTimeInterval=0;this.m_minRealTimeSendDataFactorInTimeInterval=Number.MAX_VALUE;this.m_maxRealTimeSendDataFactorInTimeInterval=Number.MIN_VALUE;this.m_totalTranscriptFactorOutsideOfThresholdCount=0;this.m_totalTranscriptMessageCountInPreviousTimeInterval=0;this.m_totalTranscriptMessageCountInCurrentTimeInterval=0;this.m_lastReceivedTranscriptTimeUTC=Number.MAX_VALUE;this.m_lastTranscriptLogUTC=Number.MIN_VALUE;this.m_realTimeReceiveDataFactorCount=0;this.m_realTimeReceiveDataFactorSum=0;this.m_minRealTimeReceiveDataFactor=Number.MAX_VALUE;this.m_maxRealTimeReceiveDataFactor=Number.MIN_VALUE;this.m_realTimeReceiveDataFactorCountInTimeInterval=0;this.m_realTimeReceiveDataFactorSumInTimeInterval=0;this.m_minRealTimeReceiveDataFactorInTimeInterval=Number.MAX_VALUE;this.m_maxRealTimeReceiveDataFactorInTimeInterval=Number.MIN_VALUE;this.m_startLogIntervalTranscript=Number.MAX_VALUE;this.m_startLogIntervalAudio=Number.MAX_VALUE;this.m_intervalTranscript=Number.MAX_VALUE;this.m_intervalAudio=Number.MAX_VALUE;this.m_fInLiveBroadcastingMode=false;this.m_prepAudioCount=0;this.m_prepAudioSum=0;this.m_minPrepAudio=Number.MAX_VALUE;this.m_maxPrepAudio=Number.MIN_VALUE;this.m_totalNetworkErrorMessageCount=0;this.m_totalNetworkWarningMessageCount=0;this.m_totalQualityErrorMessageCount=0;this.m_totalQualityWarningMessageCount=0;var b=a.s_instance;b&&SessionLogger.traceTag(40952843,logCategory.PptSession,logLevel.Warning,"Transcriber::Constructor Transcriber instance already exists. TranscriberID: "+b.m_transcriberId)}a.prototype.initialTranscriberSession=function(f,b,e,d,g){this.m_audioCtx=a.initializeAudioContext();if(!this.m_audioCtx){this.SetTranscriptionErrorText(TranscriberResourceString.GenericErrorMessage);RecordError(TelemetryErrorFieldNames.InitializeAudioContextFailed,"Failed to initialize audio context",Date.now(),true);return false}try{this.m_audioStream=f;this.m_streamSource=this.m_audioCtx.createMediaStreamSource(this.m_audioStream);if(TranscriberSettings.DynamicBufferEnabled){var c=Math.pow(2,Math.floor(Math.log(this.m_audioCtx.sampleRate*.2)/Math.log(2)));b=c<=this.c_maxBufferSize?c:this.c_maxBufferSize}this.m_sessionTelemetry[TelemetryFieldNames.BufferSize]=b;this.m_scriptNode=this.m_audioCtx.createScriptProcessor(b,e,d);this.m_wsUri=g;OpenWebSocketConnection();this.m_transcriberAccessibilityContentSpan=document.getElementById(TranscriberElementIds.AccessibilityContentSpan);this.m_transcriberResultSpan=document.getElementById(TranscriberElementIds.ResultSpanId);if(this.m_transcriberResultSpan)this.m_resultSpanPaddingValue=window.getComputedStyle(this.m_transcriberResultSpan).getPropertyValue("padding");this.m_transcriptDisplay1="";this.m_transcriptDisplay2="";this.m_fPreviousTranscriptResultFinal=false;this.m_currentSlideIndex=this.m_currentSlideIndex||0;this.m_slideCount=this.m_slideCount||0;this.m_transcriberDetectionSpan=document.getElementById(TranscriberElementIds.DetectionSpanId);this.m_transcriberDetectionDiv=document.getElementById(TranscriberElementIds.DetectionDivId);this.m_roundLatencyTimerId=0;this.m_audioSendingCountIntervalTimerId=0;this.m_sendPingMessageFlag=false;this.m_gapNumberBetweenPingPongMessage=0;return true}catch(h){this.SetTranscriptionErrorText(TranscriberResourceString.GenericErrorMessage);RecordError(TelemetryErrorFieldNames.InitializeTranscriberSessionFailed,"Failed to initialize transcriber session",Date.now(),true);return false}};a.initializeAudioContext=function(){var c=a.s_instance;if(!c){SessionLogger.traceTag(41227851,logCategory.PptSession,logLevel.Error,"Transcriber::initializeAudioContext Transcriber instance is null");return}var b;try{b=new AudioContext}catch(d){SessionLogger.traceTag(41174221,logCategory.PptSession,logLevel.Warning,"AudioContext is not supported in this browser. TranscriberID: "+c.m_transcriberId)}if(!b)try{b=new window.webkitAudioContext}catch(d){SessionLogger.traceTag(41174222,logCategory.PptSession,logLevel.Error,"Web Audio API is not supported in this browser. TranscriberID: "+c.m_transcriberId)}return b};a.generateId=function(){var a="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",b=a.replace(/[xy]/g,function(b){var a=Math.random()*16|0,c=b==="x"?a:a&3|8;return c.toString(16)});return b.toLowerCase()};a.DisposeInstance=function(){var b=a.s_instance;if(!b){SessionLogger.traceTag(40461344,logCategory.PptSession,logLevel.Warning,"Transcriber::DisposeInstance s_instance is null");return false}try{if(!b.m_sessionTelemetry[TelemetryFieldNames.WebSocketOpenedTimestamp])SessionLogger.traceTag(40759820,logCategory.PptSession,logLevel.Warning,"Transcriber::DisposeInstance WebSocketOpenedTimestamp is null. TranscriberID: "+b.m_transcriberId);else{var c=Date.now(),d=c-b.m_sessionTelemetry[TelemetryFieldNames.WebSocketOpenedTimestamp];b.m_sessionTelemetry[TelemetryFieldNames.WebSocketClosedTimestamp]=c;b.m_sessionTelemetry[TelemetryFieldNames.WebSocketConnectionDurationMS]=d}b.m_sessionTelemetry[TelemetryFieldNames.FatalErrors]=b.m_fatalErrors;b.m_sessionTelemetry[TelemetryFieldNames.NonFatalErrors]=b.m_nonFatalErrors;b.m_sessionTelemetry[TelemetryFieldNames.MaxPartialMessageLatencyMS]=b.m_maxPartialMessageLatency;b.m_sessionTelemetry[TelemetryFieldNames.MinPartialMessageLatencyMS]=b.m_minPartialMessageLatency;b.m_sessionTelemetry[TelemetryFieldNames.TotalPartialMessagesCount]=b.m_totalPartialMessagesCount;b.m_sessionTelemetry[TelemetryFieldNames.TotalHighLatencyPartialMessagesCount]=b.m_totalHighLatencyPartialMessagesCount;b.m_sessionTelemetry[TelemetryFieldNames.TotalPartialMessageLatency]=b.m_totalPartialMessageLatency;b.m_sessionTelemetry[TelemetryFieldNames.MaxFinalMessageLatencyMS]=b.m_maxFinalMessageLatency;b.m_sessionTelemetry[TelemetryFieldNames.MinFinalMessageLatencyMS]=b.m_minFinalMessageLatency;b.m_sessionTelemetry[TelemetryFieldNames.TotalFinalMessagesCount]=b.m_totalFinalMessagesCount;b.m_sessionTelemetry[TelemetryFieldNames.TotalHighLatencyFinalMessagesCount]=b.m_totalHighLatencyFinalMessagesCount;b.m_sessionTelemetry[TelemetryFieldNames.TotalFinalMessageLatency]=b.m_totalFinalMessageLatency;b.m_sessionTelemetry[TelemetryFieldNames.TotalMessageCorrelationIDNotFoundCount]=b.m_totalMessageCorrelationIDNotFoundCount;b.m_sessionTelemetry[TelemetryFieldNames.LatencyTableDeletedCount]=b.m_latencyTableDeletedCount;b.m_sessionTelemetry[TelemetryFieldNames.TotalEntriesInLatencyTable]=b.m_totalEntriesInLatencyTable;b.m_sessionTelemetry[TelemetryFieldNames.DataLoggingTimeInterval]=TranscriberSettings.DataLoggingIntervalMS;b.m_sessionTelemetry[TelemetryFieldNames.RealTimeFactorLowerThreshold]=TranscriberSettings.RealTimeFactorLowerThreshold;b.m_sessionTelemetry[TelemetryFieldNames.RealTimeFactorUpperThreshold]=TranscriberSettings.RealTimeFactorUpperThreshold;b.m_sessionTelemetry[TelemetryFieldNames.TotalAudioFactorOutsideOfThresholdCount]=b.m_totalAudioFactorOutsideOfThresholdCount;b.m_sessionTelemetry[TelemetryFieldNames.TotalTranscriptOutsideOfThresholdCount]=b.m_totalTranscriptFactorOutsideOfThresholdCount;b.m_sessionTelemetry[TelemetryFieldNames.MessageLatencyCalculationTimeMS]=b.m_messageLatencyCalculationTime;b.m_sessionTelemetry[TelemetryFieldNames.AudioFactorCalculationDurationMS]=b.m_audioFactorCalculationDuration;b.m_sessionTelemetry[TelemetryFieldNames.WebSocketRetryAttempts]=b.m_webSocketTotalRetryCountInSession;b.m_sessionTelemetry[TelemetryFieldNames.TotalNetworkErrorMessageCount]=b.m_totalNetworkErrorMessageCount;b.m_sessionTelemetry[TelemetryFieldNames.TotalNetworkWarningMessageCount]=b.m_totalNetworkWarningMessageCount;b.m_sessionTelemetry[TelemetryFieldNames.TranscriptionEndTime]=Date.now();b.m_sessionTelemetry[TelemetryFieldNames.TotalQualityErrorMessageCount]=b.m_totalQualityErrorMessageCount;b.m_sessionTelemetry[TelemetryFieldNames.TotalQualityWarningMessageCount]=b.m_totalQualityWarningMessageCount;b.LogEndOfTranscriptionSessionTelemetry();PostMessageUpward({EventType:29,SessionTelemetry:b.m_sessionTelemetry})}catch(e){SessionLogger.traceTag(40477772,logCategory.PptSession,logLevel.Error,"Transcriber::DisposeInstance threw an exception: "+e+" TranscriberID: "+b.m_transcriberId)}b.Dispose();a.s_instance=null;SessionLogger.traceTag(40461345,logCategory.PptSession,logLevel.Info,"Transcriber::DisposeInstance finish dispose transcriber instance");return true};a.prototype.Dispose=function(){SessionLogger.traceTag(42285009,logCategory.PptSession,logLevel.Info,"Transcriber::Dispose start disposing transcriber related resources");var d=Date.now();try{if(this.m_streamSource){if(this.m_scriptNode)this.m_streamSource.disconnect(this.m_scriptNode);else SessionLogger.traceTag(40461346,logCategory.PptSession,logLevel.Warning,"Transcriber::Dispose m_scriptNode null");this.m_streamSource=null}if(this.m_scriptNode){this.m_scriptNode.onaudioprocess=null;this.m_scriptNode.disconnect(this.m_audioCtx.destination);this.m_scriptNode=null}if(this.m_audioStream)this.m_audioStream.getTracks().forEach(function(a){a.stop()});else SessionLogger.traceTag(40461347,logCategory.PptSession,logLevel.Warning,"Transcriber::Dispose m_audioStream null");this.m_webSocket&&this.m_webSocket.close();var c=document.getElementById(TranscriberElementIds.TranscriberId);c&&document.body.removeChild(c);if(this.m_transcriberResultSpan)this.m_transcriberResultSpan=null;var a=document.getElementById(TranscriberElementIds.DetectionDivId);a&&document.body.removeChild(a);if(this.m_transcriberDetectionDiv)this.m_transcriberDetectionDiv=null;if(this.m_transcriberDetectionSpan)this.m_transcriberDetectionSpan=null;if(this.m_fIsRehearsal){var b=Rehearsal.GetInstance();b!=null&&b.EndRehearsal()}this.m_sessionTelemetry[TelemetryFieldNames.TranscriberDisposeDuration]=Date.now()-d}catch(f){var e=this.m_transcriberId===null?"":this.m_transcriberId;SessionLogger.traceTag(42285010,logCategory.PptSession,logLevel.Error,"Transcriber::Dispose threw an exception: "+f+" TranscriberID: "+e)}SessionLogger.traceTag(42285011,logCategory.PptSession,logLevel.Info,"Transcriber::Dispose finish disposing transcriber related resources")};a.CreateTranscribeContainer=function(f,l,m){var n=document.getElementById(TranscriberElementIds.TranscriberId);if(n)return;var d=document.createElement("div");d.id=TranscriberElementIds.TranscriberId;d.style.position="fixed";d.style.width="100%";if(f=="BottomOverlay")d.style.bottom="5%";else if(f=="TopOverlay")d.style.top="5%";else if(f=="BelowSlide")d.style.bottom="3%";else if(f=="AboveSlide")d.style.top="3%";d.style.overflow="hidden";d.style.height="11%";var c=document.createElement("div");c.id="ppt-TranscriberResultDiv";c.style.width="70%";c.style.display="inline-block";c.style.marginLeft="15%";c.style.marginRight="15%";c.style.bottom="0";c.style.position="absolute";c.style.userSelect="none";if(l)c.style.direction="rtl";var b=document.createElement("span");b.id=TranscriberElementIds.ResultSpanId;if(TranscriberSettings.AccessibilityEnabledAriaLiveState){SessionLogger.traceTag(41302227,logCategory.PptSession,logLevel.Info,"Transcriber::CreateTranscribeContainer adding accessibility attributes.");if(TranscriberSettings.AccessibilityEnabledAriaLiveState=="assertive"){b.setAttribute("aria-live","assertive");b.setAttribute("aria-atomic","true");b.setAttribute("aria-label",TranscriberResourceString.AccessibilityWindowString)}else b.setAttribute("aria-hidden","true")}b.style.fontFamily="sans-serif, mono-serif, proportional-serif, 'mono sans serif', casual, cursive, 'small caps'";b.style.backgroundColor="rgba( 0, 0, 0, 0.5 )";b.style.borderColor="rgba( 0, 0, 0, 0 )";b.style.color="rgba( 255, 255, 0, 1 )";b.style.wordWrap="break-word";b.style.display="inline-block";var a=document.createElement("span");if(TranscriberSettings.AccessibilityEnabledAriaLiveState&&TranscriberSettings.AccessibilityEnabledAriaLiveState!="assertive"){a.id=TranscriberElementIds.AccessibilityContentSpan;a.style.position="absolute";a.style.width="1px";a.style.height="1px";a.style.padding="0";a.style.margin="-1px";a.style.overflow="hidden";a.style.clip="rect(0, 0, 0, 0)";a.style.border="0";a.innerHTML="";a.setAttribute("lang",m);a.setAttribute("aria-live","assertive");a.setAttribute("aria-label",TranscriberResourceString.AccessibilityWindowString);a.setAttribute("aria-atomic",TranscriberSettings.AccessibilityEnabledAriaLiveState)}TranscriberSettings.AccessibilityEnabledAriaLiveState&&TranscriberSettings.AccessibilityEnabledAriaLiveState!="assertive"&&c.appendChild(a);c.appendChild(b);d.appendChild(c);document.body.appendChild(d);var e=document.getElementById(TranscriberElementIds.ResultSpanId),g=document.getElementById(TranscriberElementIds.TranscriberId);if(e&&g){var h=Math.floor(g.clientHeight/2),o=Math.floor(h/1.5);e.style.fontSize=o.toString()+"px";e.textContent="["+TranscriberResourceString.InitialMessage+"]";var j=e.clientHeight,k=Math.floor((h-j)/2),i=j+2*k;e.style.lineHeight=(i-1).toString()+"px";g.style.height=(i*2-2).toString()+"px";e.style.padding=k.toString()+"px";e.style.display="inline";g.oncontextmenu=function(){return false}}};a.CreateTranscribeDetectionContainer=function(){var d=document.getElementById(TranscriberElementIds.DetectionDivId);if(d){SessionLogger.traceTag(41457248,logCategory.PptSession,logLevel.Error,"Transcriber::CreateTranscribeDetectionContainer_fails TranscriberID "+a.s_instance.m_transcriberId);return}var b=document.createElement("div");b.id=TranscriberElementIds.DetectionDivId;b.style.position="fixed";b.style.minWidth="5%";b.style.height="30px";b.style.right="10pt";b.style.bottom="8pt";b.style.overflow="hidden";b.style.borderRadius="20px";var c=document.createElement("span");c.id=TranscriberElementIds.DetectionSpanId;c.style.fontFamily="sans-serif, mono-serif, proportional-serif, 'mono sans serif', casual, cursive, 'small caps'";c.style.fontSize="12pt";c.style.backgroundColor=TranscriberDetectionSettings.ColorYellew;c.style.color=TranscriberDetectionSettings.ColorBlack;c.style.display="inline-block";c.style.borderRadius="20px";b.appendChild(c);document.body.appendChild(b)};a.prototype.SetTranscriptionDetectionText=function(b,d,c,a){if(this.m_transcriberDetectionSpan!=null){if((a===undefined||a==null||!a)&&(this.m_inNetworkQualityErrorStatus||this.m_inNetworkQualityWarnStatus))return;this.m_transcriberDetectionSpan.innerHTML=b;this.m_transcriberDetectionSpan.style.color=d;this.m_transcriberDetectionSpan.style.backgroundColor=c;this.m_transcriberDetectionSpan.style.padding=b==""?"0px":"5px"}};a.prototype.EncodeWAVWithoutHeader=function(a){var c=new ArrayBuffer(a.length*2),b=new DataView(c);this.FloatTo16BitPCM(b,0,a);return b};a.prototype.FloatTo16BitPCM=function(e,c,d){for(var a=0;a<d.length;a++,c+=2){var b=Math.max(-1,Math.min(1,d[a]));e.setInt16(c,b<0?b*32768:b*32767,true)}};a.prototype.LogTranscriberInitializationTelemetry=function(){SessionLogger.traceTag(39981782,logCategory.PptSession,logLevel.Info,JSON.stringify(this.m_sessionTelemetry))};a.prototype.LogTranscriberErrorTelemetry=function(b){b[TelemetryFieldNames.TranscriberID]=a.s_instance.m_transcriberId;b[TelemetryFieldNames.CurrentTimestampMS]=Date.now();SessionLogger.traceTag(39981783,logCategory.PptSession,logLevel.Error,JSON.stringify(b))};a.prototype.LogEndOfTranscriptionSessionTelemetry=function(){SessionLogger.traceTag(39981784,logCategory.PptSession,logLevel.Info,JSON.stringify(this.m_sessionTelemetry))};a.prototype.GetTranscriptionRender=function(){var a="";if(this.m_transcriptDisplay1!==""&&this.m_transcriptDisplay2!=="")a=this.m_transcriptDisplay1+"<br>"+this.m_transcriptDisplay2;else if(this.m_transcriptDisplay1==="")a=this.m_transcriptDisplay2;else a=this.m_transcriptDisplay1;return a};a.prototype.GetTranscriptionText=function(c,e){var b=this.m_transcriptDisplay1,a=this.m_transcriptDisplay2,d=this.m_fPreviousTranscriptResultFinal;if(!e)if(d){d=false;b=a===""?b:a;a=c}else if(b===""||a==="")b=c;else a=c;else if(d){b=a===""?b:a;a=c}else{d=true;if(b===""||a==="")b=c;else a=c}this.m_transcriptDisplay1=b;this.m_transcriptDisplay2=a;this.m_fPreviousTranscriptResultFinal=d;return this.GetTranscriptionRender()};a.prototype.SetTranscriptionText=function(a,c,b){if(this.m_transcriberResultSpan!=null){if(TranscriberSettings.AccessibilityEnabledAriaLiveState)if(TranscriberSettings.AccessibilityEnabledAriaLiveState=="assertive"){this.m_transcriberResultSpan.focus();this.m_transcriberResultSpan.setAttribute("aria-live","assertive");this.m_transcriberResultSpan.setAttribute("aria-label",TranscriberResourceString.AccessibilityContentString)}else if(TranscriberSettings.AccessibilityEnabledAriaLiveState!="assertive"&&b)if(this.m_transcriberAccessibilityContentSpan!=null){this.m_transcriberAccessibilityContentSpan.innerHTML=a;this.m_transcriberAccessibilityContentSpan.getAttribute("aria-label")!=TranscriberResourceString.AccessibilityContentString&&this.m_transcriberAccessibilityContentSpan.setAttribute("aria-label",TranscriberResourceString.AccessibilityContentString);this.m_transcriberAccessibilityContentSpan.focus();this.m_transcriberAccessibilityContentSpan.setAttribute("aria-live","assertive")}this.m_transcriberResultSpan.style.color=c;this.m_transcriberResultSpan.innerHTML=this.GetTranscriptionText(a,b);this.m_transcriberResultSpan.scrollTop=this.m_transcriberResultSpan.scrollHeight;if(a!==""){this.m_transcriberResultSpan.style.padding=this.m_resultSpanPaddingValue;this.SetTranscriptionDetectionText("",TranscriberDetectionSettings.ColorWhite,TranscriberDetectionSettings.ColorWhite);this.m_inListeningStatus=false}else{this.m_transcriberResultSpan.style.padding="0px";this.SetTranscriptionDetectionText(TranscriberResourceString.DetectionString_Listening+"...",TranscriberDetectionSettings.ColorWhite,TranscriberDetectionSettings.ColorRed);this.m_inListeningStatus=true}}};a.prototype.SetTranscriptionErrorText=function(a){if(this.m_transcriberResultSpan!=null){if(TranscriberSettings.AccessibilityEnabledAriaLiveState)if(TranscriberSettings.AccessibilityEnabledAriaLiveState=="assertive"){this.m_transcriberResultSpan.focus();this.m_transcriberResultSpan.setAttribute("aria-live","assertive");this.m_transcriberResultSpan.setAttribute("aria-label",TranscriberResourceString.AccessibilityWindowString)}else if(this.m_transcriberAccessibilityContentSpan!=null){this.m_transcriberAccessibilityContentSpan.innerHTML="";this.m_transcriberAccessibilityContentSpan.getAttribute("aria-label")!=TranscriberResourceString.AccessibilityWindowString&&this.m_transcriberAccessibilityContentSpan.setAttribute("aria-label",TranscriberResourceString.AccessibilityWindowString);this.m_transcriberAccessibilityContentSpan.focus();this.m_transcriberAccessibilityContentSpan.setAttribute("aria-live","assertive")}this.m_transcriberResultSpan.style.color="rgba( 255, 255, 0, 1 )";if(!a)a=TranscriberResourceString.GenericErrorMessage;this.m_transcriberResultSpan.textContent="["+a+"]";this.m_transcriberResultSpan.scrollTop=this.m_transcriberResultSpan.scrollHeight}};a.s_instance=null;a.s_guidEmpty="00000000-0000-0000-0000-000000000000";return a}();function HandleOnMessageTranscriptionError(b){var e=Transcriber.s_instance;if(!e){SessionLogger.traceTag(42272133,logCategory.PptSession,logLevel.Error,"Transcriber::HandleOnMessageTranscriptionError Transcriber instance is null.");return}try{b==null&&SessionLogger.traceTag(40452826,logCategory.PptSession,logLevel.Warning,"Transcriber::HandleOnMessageTranscriptionError TranscriberID "+Transcriber.s_instance.m_transcriberId+" Response received from speech service was null.");var a=b.getMessageerrorcode();if(a==null||a=="")a="Unknown";var f=b.getTranscriptresult(),d="Unknown";if(f!=null)d=f.getTranscripterrorcode();var g=["ErrorProtobufDeserializationFailure","ErrorInvalidSubscriptionFromConfig","ErrorInvalidRegionFromConfig","ErrorAddSessionFailure","ErrorInvalidMessage","ErrorCreateSpeechSessionBadRequest","ErrorWaitAudioTimeout","ErrorProtobufDeserializationFailure","ErrorSpeechHandlerWebSocketFailure","ErrorSpeechRecognitionFailure","ErrorTranslationFailure","ErrorFailedToGetSupportedTextLanguages","ErrorCustomEndpointTimeout"];if(g.indexOf(a)==-1)RecordError(a,d+"_"+b.getStatus(),Date.now(),false);else e.SetTranscriptionErrorText(TranscriberResourceString.GenericErrorMessage);var c={};c[TelemetryErrorFieldNames.MessageErrorCode]=a;c[TelemetryErrorFieldNames.TranscriptErrorCode]=d;c[TelemetryErrorFieldNames.ErrorStatus]=b.getStatus();e.LogTranscriberErrorTelemetry(c)}catch(h){SessionLogger.traceTag(40452827,logCategory.PptSession,logLevel.Warning,"Transcriber::HandleOnMessageTranscriptionError TranscriberID "+Transcriber.s_instance.m_transcriberId+" Exception thrown: "+h)}}function RecordError(c,g,f,e){var b=Transcriber.s_instance;if(!b){SessionLogger.traceTag(41227852,logCategory.PptSession,logLevel.Error,"Transcriber::RecordError Transcriber instance is null.");return}var a={};if(!c)c="ErrorEmpty";a.ErrorName=c;a.ErrorReason=g;a.ClientTimestampMS=f;var d=e?b.m_fatalErrors:b.m_nonFatalErrors;if(d.length<10)d.push(a);else SessionLogger.traceTag(40452828,logCategory.PptSession,logLevel.Warning,"Transcriber::RecordError Will not append error to error list because the list contains too many errors. isFatalErrorList: "+ +e+" TranscriberID: "+b.m_transcriberId+" "+JSON.stringify(a))}function RetryWebSocketConnection(){var a=Transcriber.s_instance;if(!a){SessionLogger.traceTag(40425038,logCategory.PptSession,logLevel.Info,"Transcriber::RetryWebSocketConnection - Transcriber instance is null");return}a.m_wsTimer=0;if(a.m_webSocketConnectionRetryAttempts>=a.c_maxWebSocketRetryAttempts||a.m_webSocketTotalRetryCountInSession>=TranscriberSettings.MaxAllowedRetryCountPerSession){RecordError(TelemetryErrorFieldNames.WebSocketRetryConnectionFailed,"Maximum retry count reached",Date.now(),true);if(a.m_fIsRehearsal)a.SetTranscriptionDetectionText(TranscriberDetectionSettings.WarningSign+TranscriberResourceString.GenericNetworkErrorMessage,TranscriberDetectionSettings.ColorYellew,TranscriberDetectionSettings.ColorBlack,true);else a.SetTranscriptionErrorText(TranscriberResourceString.GenericErrorMessage);var b={};b[TelemetryErrorFieldNames.WebSocketRetryConnectionFailed]="WebSocketRetryConnectionFailed";a.LogTranscriberErrorTelemetry(b);return}SessionLogger.traceTag(40425039,logCategory.PptSession,logLevel.Info,"Transcriber::RetryWebSocketConnection - WebSocket retry attempt: "+a.m_webSocketConnectionRetryAttempts+" WebSocket total retry attempts in session: "+a.m_webSocketTotalRetryCountInSession+" TranscriberID: "+a.m_transcriberId);if(a.m_webSocket){a.m_webSocket.onclose=function(){};a.m_webSocket.close()}if(a.m_fIsRehearsal)a.SetTranscriptionDetectionText(TranscriberDetectionSettings.WarningSign+TranscriberResourceString.GenericRetryErrorMessage,TranscriberDetectionSettings.ColorYellew,TranscriberDetectionSettings.ColorBlack,true);else a.SetTranscriptionErrorText(TranscriberResourceString.RetryErrorMessage);OpenWebSocketConnection()}function RetryWebSocketConnectionWrapper(a){if(Transcriber.s_instance.m_wsTimer==0)Transcriber.s_instance.m_wsTimer=setTimeout(function(){Transcriber.s_instance.LogTranscriberErrorTelemetry(a);RetryWebSocketConnection()},Transcriber.s_instance.c_websocketRetryInterval)}function ResetIntervalStats(b){var a=Transcriber.s_instance;if(!a){SessionLogger.traceTag(41157953,logCategory.PptSession,logLevel.Info,"Transcriber::ResetIntervalStats - Transcriber instance is null");return}if(b){if(a.m_startLogIntervalAudio<Number.MAX_VALUE)a.m_intervalAudio=Date.now()-a.m_startLogIntervalAudio;a.m_startLogIntervalAudio=Date.now()}else{if(a.m_startLogIntervalTranscript<Number.MAX_VALUE)a.m_intervalTranscript=Date.now()-a.m_startLogIntervalTranscript;a.m_startLogIntervalTranscript=Date.now()}}function DetectHighLatencyWithNetworkInfo(c,b,f){var a=Transcriber.s_instance;if(!a){SessionLogger.traceTag(40425040,logCategory.PptSession,logLevel.Warning,"Transcriber::DetectHighLatencyWithNetworkInfo - Transcriber instance is null");return}if(c>=TranscriberSettings.FragmentLatencyWarnThreshold){a.m_countFragmentLatencyInWarnWindow=Math.min(TranscriberSettings.FragmentLatencyWarnWindow,a.m_countFragmentLatencyInWarnWindow+1);if(c>=TranscriberSettings.FragmentLatencyErrorThreshold)a.m_countFragmentLatencyInErrorWindow=Math.min(TranscriberSettings.FragmentLatencyErrorWindow,a.m_countFragmentLatencyInErrorWindow+1);else a.m_countFragmentLatencyInErrorWindow=Math.max(0,a.m_countFragmentLatencyInErrorWindow-1)}else if(c!=-1){a.m_countFragmentLatencyInWarnWindow=Math.max(0,a.m_countFragmentLatencyInWarnWindow-1);a.m_countFragmentLatencyInErrorWindow=Math.max(0,a.m_countFragmentLatencyInErrorWindow-1)}if(b>=TranscriberSettings.RoundtripLatencyWarnThreshold){a.m_countRoundtripLatencyInWarnWindow=Math.min(TranscriberSettings.FragmentLatencyWarnWindow,a.m_countRoundtripLatencyInWarnWindow+1);if(b>=TranscriberSettings.RoundtripLatencyErrorThreshold)a.m_countRoundtripLatencyInErrorWindow=Math.min(TranscriberSettings.FragmentLatencyErrorWindow,a.m_countRoundtripLatencyInErrorWindow+1);else a.m_countRoundtripLatencyInErrorWindow=Math.max(0,a.m_countRoundtripLatencyInErrorWindow-1)}else if(b!=-1){a.m_countRoundtripLatencyInWarnWindow=Math.max(0,a.m_countRoundtripLatencyInWarnWindow-1);a.m_countRoundtripLatencyInErrorWindow=Math.max(0,a.m_countRoundtripLatencyInErrorWindow-1)}(c>=TranscriberSettings.FragmentLatencyWarnThreshold||b>=TranscriberSettings.RoundtripLatencyWarnThreshold)&&SessionLogger.traceTag(41223618,logCategory.PptSession,logLevel.Warning,JSON.stringify({CountFragmentLatencyInErrorWindow:a.m_countFragmentLatencyInErrorWindow,CountFragmentLatencyInWarnWindow:a.m_countFragmentLatencyInWarnWindow,CountRoundtripLatencyInErrorWindow:a.m_countRoundtripLatencyInErrorWindow,CountRoundtripLatencyInWarnWindow:a.m_countRoundtripLatencyInWarnWindow,CurrentHearbeatSendInterval:a.m_currentHeartbeatSendInterval,CurrentHeartbeatLatency:a.m_currentHeartbeatLatency,PartialMessageLatency:c,RoundtripLatencyMS:b,MessageCorrelationID:f,TranscriberID:a.m_transcriberId}));var e=a.m_currentHeartbeatSendInterval>=TranscriberSettings.HeartbeatInterval+TranscriberSettings.RoundtripLatencyWarnThreshold,d=a.m_currentHeartbeatLatency>=TranscriberSettings.RoundtripLatencyWarnThreshold,g=!e&&d;if(a.m_countFragmentLatencyInErrorWindow>=TranscriberSettings.FragmentLatencyErrorWindow||a.m_countRoundtripLatencyInErrorWindow>=TranscriberSettings.FragmentLatencyErrorWindow){a.m_inNetworkQualityErrorStatus=true;a.m_totalNetworkErrorMessageCount++;a.SetTranscriptionDetectionText(TranscriberDetectionSettings.WarningSign+TranscriberResourceString.DetectionString_NetworkQualityIssue,TranscriberDetectionSettings.ColorYellew,TranscriberDetectionSettings.ColorBlack,true)}else if(a.m_countFragmentLatencyInErrorWindow==0&&a.m_countRoundtripLatencyInErrorWindow==0){a.m_inNetworkQualityErrorStatus=false;a.m_gapNumberBetweenPingPongMessage=0;!a.m_inListeningStatus&&a.SetTranscriptionDetectionText("",TranscriberDetectionSettings.ColorWhite,TranscriberDetectionSettings.ColorWhite)}if(a.m_countFragmentLatencyInWarnWindow>=TranscriberSettings.FragmentLatencyWarnWindow||a.m_countRoundtripLatencyInWarnWindow>=TranscriberSettings.FragmentLatencyWarnWindow){a.m_inNetworkQualityWarnStatus=true;a.m_totalNetworkWarningMessageCount++;!a.m_inNetworkQualityErrorStatus&&a.SetTranscriptionDetectionText(TranscriberDetectionSettings.WarningSign+TranscriberResourceString.DetectionString_NetworkQualityIssue,TranscriberDetectionSettings.ColorBlack,TranscriberDetectionSettings.ColorYellew,true)}else if(a.m_countFragmentLatencyInWarnWindow==0&&a.m_countRoundtripLatencyInWarnWindow==0){a.m_inNetworkQualityWarnStatus=false;!a.m_inListeningStatus&&a.SetTranscriptionDetectionText("",TranscriberDetectionSettings.ColorWhite,TranscriberDetectionSettings.ColorWhite)}if(a.m_inNetworkQualityErrorStatus)SessionLogger.traceTag(41223619,logCategory.PptSession,logLevel.Error,JSON.stringify({CountFragmentLatencyInErrorWindow:a.m_countFragmentLatencyInErrorWindow,CountFragmentLatencyInWarnWindow:a.m_countFragmentLatencyInWarnWindow,CountRoundtripLatencyInErrorWindow:a.m_countRoundtripLatencyInErrorWindow,CountRoundtripLatencyInWarnWindow:a.m_countRoundtripLatencyInWarnWindow,PartialMessageLatency:c,RoundtripLatencyMS:b,MessageCorrelationID:f,TranscriberID:a.m_transcriberId,CurrentHearbeatSendInterval:a.m_currentHeartbeatSendInterval,CurrentHeartbeatLatency:a.m_currentHeartbeatLatency,IsHighHeartbeatLatency:d,IsBrowserFreeze:e,IsNetworkIssue:g}));else a.m_inNetworkQualityWarnStatus&&SessionLogger.traceTag(41223620,logCategory.PptSession,logLevel.Error,JSON.stringify({CountFragmentLatencyInErrorWindow:a.m_countFragmentLatencyInErrorWindow,CountFragmentLatencyInWarnWindow:a.m_countFragmentLatencyInWarnWindow,CountRoundtripLatencyInErrorWindow:a.m_countRoundtripLatencyInErrorWindow,CountRoundtripLatencyInWarnWindow:a.m_countRoundtripLatencyInWarnWindow,PartialMessageLatency:c,RoundtripLatencyMS:b,MessageCorrelationID:f,TranscriberID:a.m_transcriberId,CurrentHearbeatSendInterval:a.m_currentHeartbeatSendInterval,CurrentHeartbeatLatency:a.m_currentHeartbeatLatency,IsHighHeartbeatLatency:d,IsBrowserFreeze:e,IsNetworkIssue:g}))}function DisplayQualityStatus(b){var a=Transcriber.s_instance;if(!a){SessionLogger.traceTag(41821152,logCategory.PptSession,logLevel.Info,"Transcriber::OpenWebSocketConnection - Transcriber instance is null");return}if(!b){SessionLogger.traceTag(41821153,logCategory.PptSession,logLevel.Error,"Transcriber::DisplayQualityStatus  Quality message null: TranscriberID: "+a.m_transcriberId);return}if(a.m_inNetworkQualityErrorStatus||a.m_inNetworkQualityWarnStatus){SessionLogger.traceTag(41821154,logCategory.PptSession,logLevel.Info,"Transcriber::DisplayQualityStatus  Already in network warn or error status: TranscriberID: "+a.m_transcriberId);return}try{var h=b.getSeverity();if(!h){SessionLogger.traceTag(41821155,logCategory.PptSession,logLevel.Error,"Transcriber::DisplayQualityStatus  Quality message Severity null: TranscriberID: "+a.m_transcriberId);return}var c=b.getShortcode(),g=b.getLongcode();if(c<2||c>5){SessionLogger.traceTag(41821184,logCategory.PptSession,logLevel.Error,"Transcriber::DisplayQualityStatus  Quality message shortCode invalid: TranscriberID: "+a.m_transcriberId);RecordError(TelemetryErrorFieldNames.QualityMessageShortcodeInvalid,"Invalid shortCode: "+c,Date.now(),false);return}switch(h){case 0:a.SetTranscriptionDetectionText("",TranscriberDetectionSettings.ColorWhite,TranscriberDetectionSettings.ColorWhite);break;case 1:a.m_totalQualityWarningMessageCount++;var f=c==null?b.getShortstring():TranscriberResourceString.QualityStatusStringDict[c];if(f!==""&&f!==undefined&&f!==null)a.SetTranscriptionDetectionText(TranscriberDetectionSettings.WarningSign+f,TranscriberDetectionSettings.ColorYellew,TranscriberDetectionSettings.ColorBlack);else f="";SessionLogger.traceTag(41821185,logCategory.PptSession,logLevel.Warning,"Transcriber::DisplayQualityStatus quality severity 1: "+f+" ; TotalQualityWarningMessageCount: "+a.m_totalQualityWarningMessageCount+" TranscriberID: "+a.m_transcriberId);break;case 2:a.m_totalQualityErrorMessageCount++;var d=c==null?b.getShortstring():TranscriberResourceString.QualityStatusStringDict[c];if(d!==""&&d!==undefined&&d!==null)a.SetTranscriptionDetectionText(TranscriberDetectionSettings.WarningSign+d,TranscriberDetectionSettings.ColorBlack,TranscriberDetectionSettings.ColorYellew);else d="";var e=g==null?b.getLongstring():TranscriberResourceString.QualityStatusStringDict[g];if(e!==""&&e!==undefined&&e!==null){a.m_timerForClearTranscriptionText!==null&&a.m_timerForClearTranscriptionText!==undefined&&clearTimeout(a.m_timerForClearTranscriptionText);a.SetTranscriptionErrorText(e);a.m_timerForClearTranscriptionText=setTimeout(resetTransciptionTextToEmpty,TranscriberSettings.ResetQualityDetectionIntervalMS)}else e="";SessionLogger.traceTag(41821186,logCategory.PptSession,logLevel.Warning,"Transcriber::DisplayQualityStatus quality severity 2: shortText: "+d+" ; longText: "+e+" TotalQualityWarningMessageCount: "+a.m_totalQualityErrorMessageCount+" TranscriberID: "+a.m_transcriberId)}}catch(i){SessionLogger.traceTag(41821187,logCategory.PptSession,logLevel.Warning,"Transcriber::DisplayQualityStatus threw an exception "+i+" TranscriberID: "+a.m_transcriberId);RecordError(TelemetryErrorFieldNames.DisplayQualityStatusException,"DisplayQualityStatusException: "+i,Date.now(),false)}}function CalculateOnMessageTelemetry(a,h,d,f){try{if(!a||!d||d==Transcriber.s_guidEmpty){SessionLogger.traceTag(41157954,logCategory.PptSession,logLevel.Warning,"Transcriber::OpenWebSocketConnection:onmessage: The correlation ID of the message was either null or the empty guid. TranscriberID: "+a.m_transcriberId+" IsRehearsal: "+a.m_fIsRehearsal);return}var w=Date.now(),b=0,g=a.m_messageLatencyTable[d];if(g){var p=Date.now();b=p-g;if(!h){a.m_totalPartialMessagesCount+=1;a.m_totalPartialMessageLatency+=b;a.m_maxPartialMessageLatency=Math.max(a.m_maxPartialMessageLatency,b);a.m_minPartialMessageLatency=Math.min(a.m_minPartialMessageLatency,b);if(b>TranscriberSettings.MaxAllowedFragmentLatencyMS){a.m_totalHighLatencyPartialMessagesCount+=1;if(!TranscriberSettings.IsLogEachTranscriptMessage){var v=a.m_totalPartialMessageLatency/a.m_totalPartialMessagesCount;SessionLogger.traceTag(40477773,logCategory.PptSession,logLevel.Warning,JSON.stringify({PartialMessageCount:a.m_totalPartialMessagesCount,PartialMessageLatency:b,MaxPartialMessageLatency:a.m_maxPartialMessageLatency,MinPartialMessageLatency:a.m_minPartialMessageLatency,AvePartialMessageLatency:v,TotalPartialMessageLatency:a.m_totalPartialMessageLatency,MessageCorrelationID:d,MessageSentTime:g,CurrentTime:p,TotalHighLatencyPartialMessagesCount:a.m_totalHighLatencyPartialMessagesCount,HeartbeatRoundtripLatency:f,TranscriberID:a.m_transcriberId,IsRehearsal:a.m_fIsRehearsal}))}}DetectHighLatencyWithNetworkInfo(b,a.m_currentHeartbeatLatency,d)}else{a.m_totalFinalMessagesCount+=1;a.m_totalFinalMessageLatency+=b;a.m_maxFinalMessageLatency=Math.max(a.m_maxFinalMessageLatency,b);a.m_minFinalMessageLatency=Math.min(a.m_minFinalMessageLatency,b);if(b>TranscriberSettings.MaxAllowedFinalFragmentLatencyMS){a.m_totalHighLatencyFinalMessagesCount+=1;if(!TranscriberSettings.IsLogEachTranscriptMessage){var v=a.m_totalFinalMessageLatency/a.m_totalFinalMessagesCount;SessionLogger.traceTag(40895813,logCategory.PptSession,logLevel.Warning,JSON.stringify({FinalMessageCount:a.m_totalFinalMessagesCount,FinalMessageLatency:b,MaxFinalMessageLatency:a.m_maxFinalMessageLatency,MinFinalMessageLatency:a.m_minFinalMessageLatency,AveFinalMessageLatency:v,TotalFinalMessageLatency:a.m_totalFinalMessageLatency,MessageCorrelationID:d,MessageSentTime:g,CurrentTime:p,TotalHighLatencyFinalMessagesCount:a.m_totalHighLatencyFinalMessagesCount,HeartbeatRoundtripLatency:f,TranscriberID:a.m_transcriberId,IsRehearsal:a.m_fIsRehearsal}))}}for(var u in a.m_messageLatencyTable){var y=a.m_messageLatencyTable[u];if(y<=g){delete a.m_messageLatencyTable[u];a.m_totalEntriesInLatencyTable-=1}}}}else{a.m_totalMessageCorrelationIDNotFoundCount+=1;SessionLogger.traceTag(40477774,logCategory.PptSession,logLevel.Warning,"Transcriber::onmessage Message correlationID: "+d+" was not present in the correlationID table. Total messages with the correlation id not found "+a.m_totalMessageCorrelationIDNotFoundCount+" TranscriberID: "+a.m_transcriberId+" isFinalMessage: "+h+" IsRehearsal: "+a.m_fIsRehearsal)}var x=Date.now()-w;a.m_messageLatencyCalculationTime+=x;var c=0,e=0,o=0;a.m_totalTranscriptMessageCountInCurrentTimeInterval++;if(a.m_totalTranscriptMessageCountInPreviousTimeInterval>0&&a.m_lastReceivedTranscriptTimeUTC<Number.MAX_VALUE){o=a.m_intervalTranscript/a.m_totalTranscriptMessageCountInPreviousTimeInterval;e=Date.now()-a.m_lastReceivedTranscriptTimeUTC;c=o/(e>0?e:1);if(c>0){a.m_realTimeReceiveDataFactorCount++;a.m_realTimeReceiveDataFactorSum+=c;a.m_minRealTimeReceiveDataFactor=Math.min(a.m_minRealTimeReceiveDataFactor,c);a.m_maxRealTimeReceiveDataFactor=Math.max(a.m_maxRealTimeReceiveDataFactor,c);a.m_realTimeReceiveDataFactorCountInTimeInterval++;a.m_realTimeReceiveDataFactorSumInTimeInterval+=c;a.m_minRealTimeReceiveDataFactorInTimeInterval=Math.min(a.m_minRealTimeReceiveDataFactorInTimeInterval,c);a.m_maxRealTimeReceiveDataFactorInTimeInterval=Math.max(a.m_maxRealTimeReceiveDataFactorInTimeInterval,c);if(!TranscriberSettings.IsLogEachTranscriptMessage)if(c<TranscriberSettings.RealTimeFactorLowerThreshold||c>TranscriberSettings.RealTimeFactorUpperThreshold){a.m_totalTranscriptFactorOutsideOfThresholdCount++;var r=0,t=0,s=0;if(a.m_realTimeReceiveDataFactorCount>0){r=a.m_realTimeReceiveDataFactorSum*1/a.m_realTimeReceiveDataFactorCount;t=a.m_minRealTimeReceiveDataFactor;s=a.m_maxRealTimeReceiveDataFactor}SessionLogger.traceTag(41157955,logCategory.PptSession,logLevel.Warning,JSON.stringify({MessageCorrelationID:d,MessageLatency:b,IsFinalMessage:h,RealTimeReceivingDataFactor:c,AvgRealTimeReceivingDataFactor:r,MinRealTimeReceivingDataFactor:t,MaxRealTimeReceivingDataFactor:s,AvgReceivingDataDurationForInterval:o,RealTimeDurationForCurrentMessage:e,TotalTranscriptMessageCountInPreviousTimeInterval:a.m_totalTranscriptMessageCountInPreviousTimeInterval,AdjustedTimeInterval:a.m_intervalTranscript,HeartbeatRoundtripLatency:f,TranscriberID:a.m_transcriberId,IsRehearsal:a.m_fIsRehearsal}))}}}var l=0,n=0,m=0,i=0,k=0,j=0;if(TranscriberSettings.IsLogEachTranscriptMessage){if(a.m_totalTranscriptMessageCountInPreviousTimeInterval==0)if(a.m_lastReceivedTranscriptTimeUTC<Number.MAX_VALUE)e=Date.now()-a.m_lastReceivedTranscriptTimeUTC;if(a.m_realTimeReceiveDataFactorCount>0){l=a.m_realTimeReceiveDataFactorSum*1/a.m_realTimeReceiveDataFactorCount;n=a.m_minRealTimeReceiveDataFactor;m=a.m_maxRealTimeReceiveDataFactor}if(a.m_realTimeReceiveDataFactorCountInTimeInterval>0){i=a.m_realTimeReceiveDataFactorSumInTimeInterval*1/a.m_realTimeReceiveDataFactorCountInTimeInterval;k=a.m_minRealTimeReceiveDataFactorInTimeInterval;j=a.m_maxRealTimeReceiveDataFactorInTimeInterval}SessionLogger.traceTag(41157956,logCategory.PptSession,logLevel.Info,JSON.stringify({MessageCorrelationID:d,MessageLatency:b,IsFinalMessage:h,RealTimeReceivingDataFactor:c,AvgRealTimeReceivingDataFactor:l,MinRealTimeReceivingDataFactor:n,MaxRealTimeReceivingDataFactor:m,AvgRealTimeReceivingDataFactorForInterval:i,MinRealTimeReceivingDataFactorForInterval:k,MaxRealTimeReceivingDataFactorForInterval:j,AvgReceivingDataDurationForInterval:o,RealTimeDurationForCurrentMessage:e,TotalTranscriptMessageCountInPreviousTimeInterval:a.m_totalTranscriptMessageCountInPreviousTimeInterval,AdjustedTimeInterval:a.m_intervalTranscript,HeartbeatRoundtripLatency:f,TranscriberID:a.m_transcriberId,IsRehearsal:a.m_fIsRehearsal}))}if(Date.now()-a.m_lastTranscriptLogUTC>TranscriberSettings.DataLoggingIntervalMS){if(!TranscriberSettings.IsLogEachTranscriptMessage){if(a.m_realTimeReceiveDataFactorCount>0){l=a.m_realTimeReceiveDataFactorSum*1/a.m_realTimeReceiveDataFactorCount;n=a.m_minRealTimeReceiveDataFactor;m=a.m_maxRealTimeReceiveDataFactor}var q=0;if(a.m_totalAudioMessageCountInPreviousTimeInterval>0)q=a.m_intervalTranscript/a.m_totalAudioMessageCountInPreviousTimeInterval;if(a.m_realTimeReceiveDataFactorCountInTimeInterval>0){i=a.m_realTimeReceiveDataFactorSumInTimeInterval*1/a.m_realTimeReceiveDataFactorCountInTimeInterval;k=a.m_minRealTimeReceiveDataFactorInTimeInterval;j=a.m_maxRealTimeReceiveDataFactorInTimeInterval}SessionLogger.traceTag(41157957,logCategory.PptSession,logLevel.Info,JSON.stringify({MessageCorrelationID:d,MessageLatency:b,IsFinalMessage:h,AvgRealTimeReceivingDataFactor:l,MinRealTimeReceivingDataFactor:n,MaxRealTimeReceivingDataFactor:m,AvgRealTimeReceivingDataFactorForInterval:i,MinRealTimeReceivingDataFactorForInterval:k,MaxRealTimeReceivingDataFactorForInterval:j,AvgReceivingDataDurationForInterval:q,TotalTranscriptMessageCountInPreviousTimeInterval:a.m_totalTranscriptMessageCountInPreviousTimeInterval,AdjustedTimeInterval:a.m_intervalTranscript,HeartbeatRoundtripLatency:f,TranscriberID:a.m_transcriberId,IsRehearsal:a.m_fIsRehearsal}))}a.m_totalTranscriptMessageCountInPreviousTimeInterval=a.m_totalTranscriptMessageCountInCurrentTimeInterval;a.m_totalTranscriptMessageCountInCurrentTimeInterval=0;a.m_realTimeReceiveDataFactorCountInTimeInterval=0;a.m_realTimeReceiveDataFactorSumInTimeInterval=0;a.m_minRealTimeReceiveDataFactorInTimeInterval=Number.MAX_VALUE;a.m_maxRealTimeReceiveDataFactorInTimeInterval=Number.MIN_VALUE;a.m_lastTranscriptLogUTC=Date.now();ResetIntervalStats(false)}a.m_lastReceivedTranscriptTimeUTC=Date.now()}catch(z){SessionLogger.traceTag(40477775,logCategory.PptSession,logLevel.Warning,"Transcriber::onmessage Calculating the message latency threw an exception: "+z+ +" TranscriberID: "+a.m_transcriberId+" IsRehearsal: "+a.m_fIsRehearsal)}}function OpenWebSocketConnection(){var a=Transcriber.s_instance;if(!a){SessionLogger.traceTag(41223621,logCategory.PptSession,logLevel.Info,"Transcriber::OpenWebSocketConnection - Transcriber instance is null");return}if(a.m_isFirstWebSocketConnection&&a.m_webSocketTotalRetryCountInSession==0)a.m_sessionTelemetry[TelemetryFieldNames.WebSocketCreateTimestamp]=Date.now();else{a.m_webSocketTotalRetryCountInSession++;a.m_webSocketConnectionRetryAttempts++}if(a.m_webSocket){SessionLogger.traceTag(41420770,logCategory.PptSession,logLevel.Warning,"Transcriber::OpenWebSocketConnection Found existing web socket connection. Closing it and will open a new one. TranscriberID: "+a.m_transcriberId);a.m_webSocket.onclose=function(){};a.m_webSocket.close()}a.m_webSocket=new WebSocket(a.m_wsUri+"&sampleRate="+a.m_audioCtx.sampleRate);a.m_webSocket.binaryType="arraybuffer";var b={};b[TelemetryFieldNames.WebSocketRetryReason]="WebSocketConnectionTimeout";TranscriberSettings.RetryEnabled&&RetryWebSocketConnectionWrapper(b);a.m_webSocket.onopen=function(){var a=Transcriber.s_instance;if(!a){SessionLogger.traceTag(40706257,logCategory.PptSession,logLevel.Info,"Transcriber::OpenWebSocketConnection:onopen - Transcriber instance is null");return}if(!a.m_fIsRehearsal)a.m_roundLatencyTimerId=setInterval(sendPingMessage,TranscriberSettings.HeartbeatInterval);else a.m_sendPingMessageFlag=false;a.m_audioSendingCountIntervalTimerId=setInterval(checkAudioSendingIn10Mins,TranscriberSettings.AudioSendingCountIntervalMS);if(a.m_isFirstWebSocketConnection){a.m_sessionTelemetry[TelemetryFieldNames.WebSocketOpenedTimestamp]=Date.now();a.m_isFirstWebSocketConnection=false}a.SetTranscriptionText("","rgba( 255, 255, 255, 1 )",false);clearTimeout(a.m_wsTimer);a.m_wsTimer=0;a.m_webSocketConnectionRetryAttempts=0};a.m_webSocket.onmessage=function(d){var a=Transcriber.s_instance;if(!a){SessionLogger.traceTag(40706258,logCategory.PptSession,logLevel.Info,"Transcriber::OpenWebSocketConnection:onmessage - Transcriber instance is null");return}if(a.m_sessionTelemetry[TelemetryFieldNames.FirstMessageLatencyMS]==undefined){var t=Date.now(),u=t-a.m_sessionTelemetry[TelemetryFieldNames.SendFirstMessageTime];a.m_sessionTelemetry[TelemetryFieldNames.FirstMessageLatencyMS]=u;a.LogTranscriberInitializationTelemetry()}if(TranscriberSettings.MessageType==="protobuf"){if(a.m_fIsRehearsal){var r=proto.Microsoft.PowerPoint.SpeechFrontDoor.ProtoBuf.SpeechResponseMessage.deserializeBinary(new Uint8Array(d.data)),i=r.getMessagetype(),s=r.getMessage_asU8();if(i=="rehearsalresultmessage"){var e=proto.Microsoft.PowerPoint.SpeechFrontDoor.ProtoBuf.RehearsalResultMessage.deserializeBinary(new Uint8Array(s)),j=Rehearsal.GetInstance();j!=null&&j.UpdateRehearsalDashboard(e);var p=e.getCorrelationid().toLowerCase(),n=e.getIsfinal();CalculateOnMessageTelemetry(a,n,p,-1);return}else if(i=="qualitystatusmessage"){var o=proto.Microsoft.PowerPoint.SpeechFrontDoor.ProtoBuf.QualityStatusMessage.deserializeBinary(new Uint8Array(s));DisplayQualityStatus(o);return}else{SessionLogger.traceTag(41726081,logCategory.PptSession,logLevel.Error,"Transcriber::OpenWebSocketConnection:onmessage: Unexpected message type in rehearsal scenario: "+String(i));return}}var b=TranscriberSettings.fSupportSpeechResponseMessage?proto.Microsoft.PowerPoint.SpeechFrontDoor.ProtoBuf.SpeechResponseMessage.deserializeBinary(new Uint8Array(d.data)):proto.Microsoft.PowerPoint.SpeechFrontDoor.ProtoBuf.SpeechResultMessage.deserializeBinary(new Uint8Array(d.data));if(TranscriberSettings.fSupportSpeechResponseMessage){var q=b.getMessagetype(),m=b.getMessage_asU8();if(q=="qualitystatusmessage"){var o=proto.Microsoft.PowerPoint.SpeechFrontDoor.ProtoBuf.QualityStatusMessage.deserializeBinary(new Uint8Array(m));DisplayQualityStatus(o);return}else if(q=="speechresultmessage")b=proto.Microsoft.PowerPoint.SpeechFrontDoor.ProtoBuf.SpeechResultMessage.deserializeBinary(new Uint8Array(m));else return}var c=-1;if(b.getStatus()==="success"){var v=b.getTranscriptresult().getIspongmessage();if(v){a.m_gapNumberBetweenPingPongMessage=Math.max(0,a.m_gapNumberBetweenPingPongMessage-1);var f=Date.now();c=f-a.m_heartbeatSendTime;a.m_currentHeartbeatLatency=c;var g=b.getCorrelationid().toLowerCase();!TranscriberSettings.IsLogEachTranscriptMessage&&c>TranscriberSettings.RoundtripLatencyWarnThreshold&&SessionLogger.traceTag(41003223,logCategory.PptSession,logLevel.Warning,JSON.stringify({RoundtripLatency:c,HeartbeatSendTime:a.m_heartbeatSendTime,HeartbeatReceiveTime:f,TranscriberID:a.m_transcriberId,CorrelationID:g}));TranscriberSettings.IsLogEachTranscriptMessage&&SessionLogger.traceTag(41223622,logCategory.PptSession,logLevel.Info,JSON.stringify({RoundtripLatency:c,HeartbeatSendTime:a.m_heartbeatSendTime,HeartbeatReceiveTime:f,TranscriberID:a.m_transcriberId,CorrelationID:g}));DetectHighLatencyWithNetworkInfo(-1,a.m_currentHeartbeatLatency,g);return}if(a.m_inNetworkQualityErrorStatus){SessionLogger.traceTag(41948359,logCategory.PptSession,logLevel.Warning,"Transcriber::OpenWebSocketConnection:onmessage: In network error status, temporarily disable subtitles");RecordError(TelemetryErrorFieldNames.TemporaryDisableSubtitleDueNetworkError,"Network error with error windows : "+a.m_countFragmentLatencyInErrorWindow,Date.now(),false);return}var h=b.getTranscriptresult().getTranscriptsMap();h.forEach(function(c,d){var a=Transcriber.s_instance;if(!a){SessionLogger.traceTag(40706259,logCategory.PptSession,logLevel.Info,"Transcriber::OpenWebSocketConnection:onmessage: display transcription - Transcriber instance is null");return}if(c===h.get(d)&&a.m_translationLanguages.indexOf(d)!=-1){var e=b.getTranscriptresult().getIsfinal();a.m_timerForClearTranscriptionText!==null&&a.m_timerForClearTranscriptionText!==undefined&&clearTimeout(a.m_timerForClearTranscriptionText);a.m_timerForShowListeningDetectionMessage!==null&&a.m_timerForShowListeningDetectionMessage!==undefined&&clearTimeout(a.m_timerForShowListeningDetectionMessage);a.SetTranscriptionText(c,"rgba( 255, 255, 255, 1 )",e);a.m_timerForClearTranscriptionText=setTimeout(resetTransciptionTextToEmpty,TranscriberSettings.ResetTranscriptionTextIntervalMS)}});try{if(Transcriber.s_instance&&Transcriber.s_instance.m_fInLiveBroadcastingMode){var k=[];h.forEach(function(b,a){Transcriber.s_instance.m_translationLanguagesForLive.indexOf(a)!=-1&&k.push({language:a,transript:b})});PostMessageUpward({EventType:30,Transcripts:k,IsFinal:b.getTranscriptresult().getIsfinal()})}}catch(w){SessionLogger.traceTag(41759266,logCategory.PptSession,logLevel.Error,"Transcriber::OpenWebSocketConnection: Posting Live broadcasting subtitle threw an exception: "+w+" TranscriberID: "+a.m_transcriberId)}var p=b.getCorrelationid().toLowerCase(),l=b.getTranscriptresult(),n=l!=null?l.getIsfinal():false;CalculateOnMessageTelemetry(a,n,p,c)}else HandleOnMessageTranscriptionError(b)}else a.SetTranscriptionText(d.data,"rgba( 255, 255, 255, 1 )",true)};a.m_webSocket.onclose=function(c){var a=Transcriber.s_instance;if(!a){SessionLogger.traceTag(40425041,logCategory.PptSession,logLevel.Warning,"Transcriber::WebSocket closed after instance has been disposed");return}a.m_roundLatencyTimerId!==0&&clearInterval(a.m_roundLatencyTimerId);a.m_audioSendingCountIntervalTimerId!==0&&clearInterval(a.m_audioSendingCountIntervalTimerId);if(c.type==="NoAudioIn10Mins"&&c.code===4001){RecordError(TelemetryErrorFieldNames.ErrorNoAudioSend,"Close Websocket since no audio message in 10 mins",Date.now(),true);var b={};b[TelemetryErrorFieldNames.ErrorNoAudioSend]="WebSocketNoAudioSendInMins";a.LogTranscriberErrorTelemetry(b);return}if(c.code!=1e3){var b={};b[TelemetryErrorFieldNames.WebSocketErrorCode]=c.code;b[TelemetryFieldNames.WebSocketRetryReason]="WebSocketDisconnected";TranscriberSettings.RetryEnabled&&RetryWebSocketConnectionWrapper(b)}}}function setTranscriberUIVisibility(a){var d=Transcriber.s_instance;if(!d){SessionLogger.traceTag(41775949,logCategory.PptSession,logLevel.Info,"toggleTranscriberUI Transcriber instance is null");return}try{var c=document.getElementById(TranscriberElementIds.DetectionDivId),b=document.getElementById(TranscriberElementIds.TranscriberId);if(a==null){if(b==null){SessionLogger.traceTag(50595553,logCategory.PptSession,logLevel.Warning,"Canot determine intended visibility mode!");return}a=b.style.visibility!="hidden"}if(a)switch(TranscriberSettings.TranscriberPosition){case"AboveSlide":PostMessageUpward({EventType:31,IsStartTranscription:true,SubtitlesPosition:"TopOverlay"});break;case"BelowSlide":PostMessageUpward({EventType:31,IsStartTranscription:true,SubtitlesPosition:"BottomOverlay"})}else PostMessageUpward({EventType:31,IsStartTranscription:true,SubtitlesPosition:TranscriberSettings.TranscriberPosition});if(c!=null)c.style.visibility=a?"hidden":"visible";if(b!=null)b.style.visibility=a?"hidden":"visible"}catch(e){SessionLogger.traceTag(41775950,logCategory.PptSession,logLevel.Warning,"Transcriber UI toggling threw an exception "+e+" TranscriberID: "+d.m_transcriberId)}}function setTranscriberLiveBroadcastMode(a,c){TranscriberSettings.LivePraugueSessionInfo=a?c:"";var b=Transcriber.s_instance;if(!b){SessionLogger.traceTag(41682721,logCategory.PptSession,logLevel.Info,"Transcriber::setTranscriberLiveBroadcastMode Transcriber instance is null");return}SessionLogger.traceTag(41682722,logCategory.PptSession,logLevel.Info,"Transcriber::setTranscriberLiveBroadcastMode:"+a);b.m_fInLiveBroadcastingMode=a}function recordGetUserMediaError(h,g,e,c){if(!readTranscriberSettings(h,g,e,"","")){RecordError(TelemetryErrorFieldNames.ReadSettingsFailed,"Failed to read settings",Date.now(),true);return}if(!TranscriberSettings.IsStartTranscription){var b=Transcriber.s_instance;if(b){var f=Transcriber.DisposeInstance();!f&&SessionLogger.traceTag(41543387,logCategory.PptSession,logLevel.Warning,"Transcriber::recordGetUserMediaError dispose transcriber instance. Id "+b.m_transcriberId)}return}Transcriber.s_instance=new Transcriber;var a=Transcriber.s_instance;if(!a){SessionLogger.traceTag(41543388,logCategory.PptSession,logLevel.Info,"Transcriber::displayGetUserMediaError Transcriber instance is null");return}SessionLogger.traceTag(41543389,logCategory.PptSession,logLevel.Info,"Transcriber::displayGetUserMediaError error: "+c);var d=TranscriberSettings.RTLLanguages.search(TranscriberSettings.TranslationLanguages)!=-1;Transcriber.CreateTranscribeContainer(TranscriberSettings.TranscriberPosition,d,TranscriberSettings.TranslationLanguages);a.m_transcriberResultSpan=document.getElementById(TranscriberElementIds.ResultSpanId);a.SetTranscriptionErrorText(TranscriberResourceString.ErrorAudioDevice);RecordError(TelemetryErrorFieldNames.GetUserMediaFailed,"Error: "+c,Date.now(),false);return}function notifyTranscriberOnSlideChange(c){var a=Transcriber.s_instance;if(!a){SessionLogger.traceTag(41726082,logCategory.PptSession,logLevel.Error,"Transcriber::notifyTranscriberOnSlideChange Transcriber instance is null");return}a.m_currentSlideIndex=c;var b=Rehearsal.GetInstance();b!=null&&b.UpdateSlideTracker(a.m_currentSlideIndex)}function readTranscriberSettings(n,m,l,g,f){try{var a=JSON.parse(n);TranscriberSettings.WacUserSessionId=a.WacUserSessionId;TranscriberSettings.WacUserDatacenterCluster=a.WacUserDatacenterCluster;TranscriberSettings.PodSessionId=a.PodSessionId;TranscriberSettings.DocId=a.DocId;TranscriberSettings.EntryPoint=a.EntryPoint;TranscriberSettings.StartTime=a.StartTime;TranscriberSettings.WebServiceBase=a.PodsWebServiceBase;TranscriberSettings.IsDockedViewEnabled=a.IsDockedViewEnabled;TranscriberSettings.DataLoggingIntervalMS=a.TranscriberLoggingIntervalInMS;TranscriberSettings.RealTimeFactorLowerThreshold=a.TranscribeRealTimeFactorLowerThreshold;TranscriberSettings.RealTimeFactorUpperThreshold=a.TranscribeRealTimeFactorUpperThreshold;TranscriberSettings.IsLogEachTranscriptMessage=a.IsTranscriberLogEachTranscriptMessage;TranscriberSettings.AccessibilityEnabledAriaLiveState=a.TranscriberAccessibilityEnabledAriaLiveState;TranscriberSettings.IsContentLoggingEnabled=a.IsTranscriberContentLoggingEnabled;TranscriberSettings.IsCustomEndpointEnabled=a.FUseEndpointInWebapp;TranscriberSettings.CustomEndpointRequestTimeoutInMs=a.CustomEndpointRequestTimeoutInMs;TranscriberSettings.RTLLanguages=a.RTLLanguages;TranscriberSettings.HeartbeatInterval=a.HeartbeatInterval;TranscriberSettings.RoundtripLatencyWarnThreshold=a.RoundtripLatencyThreshold;TranscriberSettings.RoundtripLatencyErrorThreshold=a.RoundtripLatencyThreshold*5;TranscriberSettings.AudioSendingCountIntervalMS=a.AudioSendingCountIntervalMS;TranscriberSettings.FragmentLatencyWarnThreshold=a.FragmentLatencyWarnThreshold;TranscriberSettings.FragmentLatencyErrorThreshold=a.FragmentLatencyErrorThreshold;TranscriberSettings.IsReactiveUXEnabled=a.FEnableTranscriberReactiveUX;TranscriberSettings.MessageType=a.MessageType;TranscriberSettings.RetryEnabled=a.RetryEnabled;TranscriberSettings.MaxAllowedFragmentLatencyMS=a.MaxAllowedFragmentLatencyMS;TranscriberSettings.DynamicBufferEnabled=a.DynamicBufferEnabled;TranscriberSettings.DefaultBufferSize=a.DefaultBufferSize;TranscriberSettings.MaxAllowedFinalFragmentLatencyMS=a.MaxAllowedFinalFragmentLatencyMS;TranscriberSettings.fSupportSpeechResponseMessage=a.FSupportSpeechResponseMessage;TranscriberSettings.TranscriberShowListeningDetectionTextInMS=a.TranscriberShowListeningDetectionTextInMS}catch(o){SessionLogger.traceTag(41775238,logCategory.PptSession,logLevel.Error,"Transcriber::readTranscriberSettings: Parse appSettings json string threw exception: "+o);return false}try{var d=JSON.parse(m);TranscriberSettings.TranscriberPosition=d.SubtitlesPosition;TranscriberSettings.SpeechLanguage=d.SpeechLanguage;TranscriberSettings.TranslationLanguages=d.TranslationLanguages;TranscriberSettings.IsStartTranscription=d.FUseSubtitles}catch(o){SessionLogger.traceTag(41775239,logCategory.PptSession,logLevel.Error,"Transcriber::readTranscriberSettings: Parse subtitlesContextInfo json string threw exception"+o);return false}try{var b=JSON.parse(l);TranscriberResourceString.InitialMessage=b.InitialMessage;TranscriberResourceString.GenericErrorMessage=b.GenericErrorMessage;TranscriberResourceString.RetryErrorMessage=b.RetryErrorMessage;TranscriberResourceString.DetectionString_HighJitter=b.Detection_HighJitter;TranscriberResourceString.DetectionString_HighLatency=b.Detection_HighLatency;TranscriberResourceString.DetectionString_Listening=b.Detection_Listening;TranscriberResourceString.DetectionString_NetworkQualityIssue=b.Detection_NetworkQualityIssue;TranscriberResourceString.AccessibilityContentString=b.Accessibility_Content;TranscriberResourceString.AccessibilityWindowString=b.Accessibility_Window;TranscriberResourceString.ErrorAudioDevice=b.ErrorAudioDevice;TranscriberResourceString.GenericRetryErrorMessage=b.GenericRetryErrorMessage;TranscriberResourceString.GenericNetworkErrorMessage=b.GenericNetworkErrorMessage;TranscriberResourceString.QualityStatusStringDict[2]=b.Detection_AudioQualityIssue;TranscriberResourceString.QualityStatusStringDict[3]=b.Detection_HighBackgroundNoise;TranscriberResourceString.QualityStatusStringDict[4]=b.Detection_SpeakingTooLoud;TranscriberResourceString.QualityStatusStringDict[5]=b.Detection_SpeakingTooQuiet;TranscriberResourceString.QualityStatusStringDict[10]=b.DetectionText_AudioQualityIssue;TranscriberResourceString.QualityStatusStringDict[11]=b.DetectionText_HighBackgroundNoise;TranscriberResourceString.QualityStatusStringDict[12]=b.DetectionText_SpeakingTooLoud;TranscriberResourceString.QualityStatusStringDict[13]=b.DetectionText_SpeakingTooQuiet}catch(o){SessionLogger.traceTag(41775240,logCategory.PptSession,logLevel.Error,"Transcriber::readTranscriberSettings: Parse subtitlesResourceStr json string threw exception"+o);return false}TranscriberSettings.ServiceRequestTranslationLanguages=TranscriberSettings.TranslationLanguages;if(f.length>0)try{var h=JSON.parse(f);TranscriberSettings.TranslationLanguagesForLive=h.TranslationLanguages;TranscriberSettings.HideUIWhenSwitchingToLiveBroadcastingMode=h.HideUIWhenSwitchingToLiveBroadcastingMode;if(TranscriberSettings.TranslationLanguagesForLive.length>0){var e=",",k=TranscriberSettings.TranslationLanguages.split(e),j=TranscriberSettings.TranslationLanguagesForLive.split(e),i=k.concat(j).filter(function(a,c,b){return c===b.indexOf(a)&&a.trim().length!=0});TranscriberSettings.ServiceRequestTranslationLanguages=i.join(e)}}catch(o){SessionLogger.traceTag(41985924,logCategory.PptSession,logLevel.Error,"Transcriber::readTranscriberSettings: Parse liveContextStr json string threw exception"+o);return false}if(g.length>0)try{var c=JSON.parse(g);TranscriberSettings.IsStartRehearsal=c.IsStartRehearsal;TranscriberSettings.SlideCount=c.SlideCount;TranscriberSettings.StartingSlideIndex=c.StartingSlideIndex-1;TranscriberSettings.WacUserSessionId=c.WacUserSessionId;TranscriberSettings.WacUserDatacenterCluster=c.WacUserDatacenterCluster;if(TranscriberSettings.IsStartRehearsal)TranscriberSettings.fSupportSpeechResponseMessage=true}catch(o){SessionLogger.traceTag(42063389,logCategory.PptSession,logLevel.Error,"Transcriber::readTranscriberSettings: Parse rehearsalContextStr json string threw exception"+o);return false}return true}function getSpeechMode(a){return a?a.m_fIsRehearsal?"Rehearsal":a.m_fInLiveBroadcastingMode?"Live":"Subtitles":"Unknown"}function startTranscriber(d,v,t,s,i,r){Transcriber.s_instance&&TranscriberSettings.IsStartTranscription&&SessionLogger.traceTag(42285012,logCategory.PptSession,logLevel.Warning,"Transcriber::startTranscriber already has existed instance. TranscriberID: "+Transcriber.s_instance.m_transcriberId);var p=Date.now();if(!readTranscriberSettings(v,t,s,i,r)){RecordError(TelemetryErrorFieldNames.ReadSettingsFailed,"Failed to read settings",Date.now(),true);return}var x=new UlsSessionLogger(TranscriberSettings.WacUserSessionId,TranscriberSettings.WebServiceBase);SessionLogger.init(x);var c=Transcriber.generateId();SessionLogger.traceTag(41775241,logCategory.PptSession,logLevel.Info,JSON.stringify({StartingTranscription:TranscriberSettings.IsStartTranscription,EnableCustomEndpoint:TranscriberSettings.IsCustomEndpointEnabled,TranscriptionEntryPoint:TranscriptionEntryPoint[TranscriberSettings.EntryPoint],TranscriberID:c,IsRehearsal:TranscriberSettings.IsStartRehearsal}));TranscriberSettings.IsDockedViewEnabled&&!TranscriberSettings.IsStartRehearsal&&TranscriberSettings.EntryPoint!=TranscriptionEntryPoint.LiveBroadcast&&PostMessageUpward({EventType:31,IsStartTranscription:TranscriberSettings.IsStartTranscription,SubtitlesPosition:TranscriberSettings.TranscriberPosition});if(!TranscriberSettings.IsStartTranscription&&!TranscriberSettings.IsStartRehearsal){var f=Transcriber.s_instance,h="null";if(f)h=f.m_transcriberId;SessionLogger.traceTag(41775242,logCategory.PptSession,logLevel.Info,"Transcriber::startTranscriber Calling Transcriber.DisposeInstance to end the transcription session. TranscriberId of current instance: "+h);var u=Transcriber.DisposeInstance();if(!u){f=Transcriber.s_instance;var l=false;if(f)l=true;SessionLogger.traceTag(41775243,logCategory.PptSession,logLevel.Warning,"Transcriber::startTranscriber Ending the transcription session "+ +"but the transcriber instance was not successfully disposed. Transcriber.s_instance exists: "+l+" TranscriberId of instance that was attempted to be disposed: "+h)}return}var j=TranscriberSettings.DefaultBufferSize;if(!isNaN(j))TranscriberSettings.DefaultBufferSize=j;Transcriber.s_instance=new Transcriber;var a=Transcriber.s_instance;if(!a){SessionLogger.traceTag(41775244,logCategory.PptSession,logLevel.Info,"Transcriber::startTranscriber Transcriber instance is null");return}a.m_fIsRehearsal=TranscriberSettings.IsStartRehearsal;a.m_fIsTranscribe=TranscriberSettings.IsStartTranscription;a.m_sessionTelemetry[TelemetryFieldNames.TranscriptionEntryPointCalled]=p;a.m_sessionTelemetry[TelemetryFieldNames.SpeechLanguage]=TranscriberSettings.SpeechLanguage;a.m_sessionTelemetry[TelemetryFieldNames.TranslationLanguage]=TranscriberSettings.TranslationLanguages;a.m_sessionTelemetry[TelemetryFieldNames.ServiceRequestTranslationLanguages]=TranscriberSettings.ServiceRequestTranslationLanguages;a.m_translationLanguages=TranscriberSettings.TranslationLanguages;a.m_translationLanguagesForLive=TranscriberSettings.TranslationLanguagesForLive;a.m_sessionTelemetry[TelemetryFieldNames.FEnableContentlogging]=TranscriberSettings.IsContentLoggingEnabled;a.m_sessionTelemetry[TelemetryFieldNames.SpeechMode]=a.m_fIsRehearsal?"Rehearsal":"Subtitles";a.m_sessionTelemetry[TelemetryFieldNames.TranscriberPosition]=TranscriberSettings.TranscriberPosition;if(a.m_fIsTranscribe&&!a.m_fIsRehearsal){var q=TranscriberSettings.RTLLanguages.search(TranscriberSettings.TranslationLanguages)!=-1;a.m_sessionTelemetry[TelemetryFieldNames.CreateTranscribeContainerStartTimeMS]=Date.now();Transcriber.CreateTranscribeContainer(TranscriberSettings.TranscriberPosition,q,TranscriberSettings.TranslationLanguages);a.m_sessionTelemetry[TelemetryFieldNames.CreateTranscribeContainerEndTimeMS]=Date.now()}a.m_fInLiveBroadcastingMode=TranscriberSettings.EntryPoint==TranscriptionEntryPoint.LiveBroadcast;a.m_fInLiveBroadcastingMode&&setTranscriberUIVisibility(a.m_fInLiveBroadcastingMode);a.m_sessionTelemetry[TelemetryFieldNames.SpeechMode]=getSpeechMode(a);TranscriberSettings.IsReactiveUXEnabled&&Transcriber.CreateTranscribeDetectionContainer();if(a.m_fIsRehearsal){a.m_currentSlideIndex=TranscriberSettings.StartingSlideIndex;a.m_slideCount=TranscriberSettings.SlideCount;a.m_podsUrl=TranscriberSettings.WebServiceBase;a.m_podsId=TranscriberSettings.PodSessionId;var k=Rehearsal.GetInstance();k!=null&&k.Initialize(c,a.m_currentSlideIndex,a.m_slideCount,i)}a.m_sessionTelemetry[TelemetryFieldNames.CustomEndpointEnabled]=TranscriberSettings.IsCustomEndpointEnabled;if(!TranscriberSettings.IsCustomEndpointEnabled)OnGetUserMediaSuccess(d,null,c,OnGetUserMediaSuccessEntryPoint.CustomEndpointNotEnabled);else{if(TranscriberSettings.DocId.length===0){RecordError(TelemetryErrorFieldNames.InvalidDocId,"",Date.now(),false);var m={};m[TelemetryErrorFieldNames.CustomEndpointClientFailureReason]="InvalidDocId";a.LogTranscriberErrorTelemetry(m);OnGetUserMediaSuccess(d,null,c,OnGetUserMediaSuccessEntryPoint.InvalidDocId);return}var n=TranscriberSettings.DocId,o=TranscriberSettings.DocId.indexOf("access_token");if(o===-1)SessionLogger.traceTag(41775246,logCategory.PptSession,logLevel.Warning,"Transcriber::RequestCustomEndpoint access_token was not found in docID. TranscriberID: "+c);else n=TranscriberSettings.DocId.substring(0,o);var g=Transcriber.generateId();SessionLogger.traceTag(41775247,logCategory.PptSession,logLevel.Info,"Transcriber::RequestCustomEndpoint CorrelationID: "+g+" TranscriberID: "+c);a.m_sessionTelemetry[TelemetryFieldNames.CustomEndpointRequestCorrelationID]=g;var e=null,w=queryParams.TranscriberURI.replace("wss","https"),y=w+"CustomEndpointHandler.ashx?action=GetOrCreateCustomEndpoint"+("&podurl="+TranscriberSettings.WebServiceBase)+("&PODSID="+TranscriberSettings.PodSessionId)+("&docid="+n)+("&locale="+TranscriberSettings.SpeechLanguage)+"&client=web&contenttype=url"+("&fenablecontentlogging="+TranscriberSettings.IsContentLoggingEnabled)+("&correlationid="+g)+("&wacusersessionid="+TranscriberSettings.WacUserSessionId)+("&wacuserdatacluster="+TranscriberSettings.WacUserDatacenterCluster),b=new XMLHttpRequest;a.m_sessionTelemetry[TelemetryFieldNames.RequestCustomEndpointStartTimeMS]=Date.now();b.open("POST",y,true);b.timeout=TranscriberSettings.CustomEndpointRequestTimeoutInMs;b.send();b.onload=function(){SessionLogger.traceTag(41775248,logCategory.PptSession,logLevel.Info,"Transcriber::startTranscriber OnLoad Transcriber ID: "+c);a.m_sessionTelemetry[TelemetryFieldNames.RequestCustomEndpointEndTimeMS]=Date.now();e=b.getResponseHeader("X-EndpointID");a.m_transcriberId==null&&OnGetUserMediaSuccess(d,e,c,OnGetUserMediaSuccessEntryPoint.OnLoadCustomEndpointRequest)};b.onerror=function(){SessionLogger.traceTag(41775249,logCategory.PptSession,logLevel.Info,"Transcriber::startTranscriber OnError Transcriber ID: "+c);RecordError(TelemetryErrorFieldNames.CustomEndpointServerError,b.getResponseHeader("X-ErrorCode")+" "+b.getResponseHeader("X-FailureReason")+" "+ +b.status,Date.now(),false);a.m_sessionTelemetry[TelemetryFieldNames.RequestCustomEndpointFailedEndTimeMS]=Date.now();var f={};f[TelemetryErrorFieldNames.CustomEndpointServerErrorCode]=b.getResponseHeader("X-ErrorCode");f[TelemetryErrorFieldNames.CustomEndpointServerFailureReason]=b.getResponseHeader("X-FailureReason");a.LogTranscriberErrorTelemetry(f);a.m_transcriberId==null&&OnGetUserMediaSuccess(d,e,c,OnGetUserMediaSuccessEntryPoint.OnErrorCustomEndpointRequest)};b.ontimeout=function(){SessionLogger.traceTag(41775250,logCategory.PptSession,logLevel.Info,"Transcriber::startTranscriber OnTimeout Transcriber ID: "+c);RecordError(TelemetryErrorFieldNames.CustomEndpointClientError,"CustomEndpointRequestTimeout",Date.now(),false);a.m_sessionTelemetry[TelemetryFieldNames.RequestCustomEndpointTimedOutEndTimeMS]=Date.now();var b={};b[TelemetryErrorFieldNames.CustomEndpointClientFailureReason]="CustomEndpointRequestTimeout";a.LogTranscriberErrorTelemetry(b);a.m_transcriberId==null&&OnGetUserMediaSuccess(d,e,c,OnGetUserMediaSuccessEntryPoint.OnTimeoutCustomEndpointRequest)}}}function sendPingMessage(){var a=Transcriber.s_instance;if(!a){SessionLogger.traceTag(41685893,logCategory.PptSession,logLevel.Info,"sendPingMessage - Transcriber instance is null");return}if(a.m_sendPingMessageFlag==false)a.m_sendPingMessageFlag=true}function displayListeningDetectionText(){var a=Transcriber.s_instance;a&&a.m_transcriberDetectionSpan!=null&&a.SetTranscriptionDetectionText(TranscriberResourceString.DetectionString_Listening+"...",TranscriberDetectionSettings.ColorWhite,TranscriberDetectionSettings.ColorRed)}function resetTransciptionTextToEmpty(){var a=Transcriber.s_instance;if(a&&a.m_transcriberResultSpan!=null){a.m_transcriberResultSpan.style.color="rgba(255, 255, 255, 1)";a.m_transcriberResultSpan.innerHTML="";a.m_transcriberResultSpan.scrollTop=a.m_transcriberResultSpan.scrollHeight;a.m_transcriberResultSpan.style.padding="0px";a.m_transcriptDisplay1="";a.m_transcriptDisplay2="";a.m_fPreviousTranscriptResultFinal=false;a.m_timerForClearTranscriptionText=null;a.m_timerForShowListeningDetectionMessage=setTimeout(displayListeningDetectionText,TranscriberSettings.TranscriberShowListeningDetectionTextInMS);a.m_inListeningStatus=true}}function checkAudioSendingIn10Mins(){var a=Transcriber.s_instance;if(!a){SessionLogger.traceTag(41199754,logCategory.PptSession,logLevel.Info,"checkAudioSendingInMins - Transcriber instance is null");return}if(a.m_totalAudioMessageCountInMins>0)a.m_totalAudioMessageCountInMins=0;else{var b={code:4001,reason:"NoAudioIn10Mins",wasClean:false},c=new CloseEvent("NoAudioIn10Mins",b);a.m_webSocket.onclose(c)}}function OnGetUserMediaSuccess(j,b,i,f){var a=Transcriber.s_instance;if(!a){SessionLogger.traceTag(41157959,logCategory.PptSession,logLevel.Info,"Transcriber::OnGetUserMediaSuccess Transcriber instance is null");return}a.m_transcriberId=i;var d=queryParams.TranscriberURI+"SpeechHandler.ashx?action=Transcribe&client=web"+("&session="+TranscriberSettings.WacUserSessionId+"_"+a.m_transcriberId)+("&message="+TranscriberSettings.MessageType);if(a.m_fIsRehearsal)d=d+"&speechMode=rehearsal"+("&PodSID="+a.m_podsId)+("&podurl="+a.m_podsUrl)+("&wacusersessionid="+TranscriberSettings.WacUserSessionId)+("&wacuserdatacluster="+TranscriberSettings.WacUserDatacenterCluster);var k=d,c="Unknown";if(queryParams.TranscriberURI.toLowerCase().indexOf(".edog")!=-1)c="EDog";else if(queryParams.TranscriberURI.toLowerCase().indexOf(".live-int.")!=-1)c="Int";else c="Production";a.m_sessionTelemetry[TelemetryFieldNames.Endpoint]=c;a.m_sessionTelemetry[TelemetryFieldNames.TranscriberID]=a.m_transcriberId;a.m_sessionTelemetry[TelemetryFieldNames.TranscriptionEntryPoint]=TranscriptionEntryPoint[TranscriberSettings.EntryPoint];a.m_sessionTelemetry[TelemetryFieldNames.TranscriptionStartTime]=TranscriberSettings.StartTime;a.m_sessionTelemetry[TelemetryFieldNames.OnGetUserMediaSuccessEntryPoint]=OnGetUserMediaSuccessEntryPoint[f];a.m_lastTranscriptLogUTC=Date.now();a.m_lastAudioLogUTC=Date.now();a.m_intervalAudio=TranscriberSettings.DataLoggingIntervalMS;a.m_intervalTranscript=TranscriberSettings.DataLoggingIntervalMS;var e=document.getElementById("pptViewerAnchor-Met");if(!e||e.getBoundingClientRect().width==0){var g=a.m_transcriberId,h=Transcriber.DisposeInstance();SessionLogger.traceTag(40461377,logCategory.PptSession,logLevel.Warning,"Transcriber::OnGetUserMediaSuccess Dispose transcriber instance because SlideShow has been exited. Returned: "+ +h+" TranscriberID: "+g);return}a.m_sessionTelemetry[TelemetryFieldNames.InitializeWebSocketStartTimeMS]=Date.now();if(!a.initialTranscriberSession(j,TranscriberSettings.DefaultBufferSize,1,1,k)){SessionLogger.traceTag(41174223,logCategory.PptSession,logLevel.Info,"Transcriber::OnGetUserMediaSuccess: Initialize websocket failed. TranscriberID: "+a.m_transcriberId);return}a.m_sessionTelemetry[TelemetryFieldNames.InitializeWebSocketEndTimeMS]=Date.now();a.m_scriptNode.onaudioprocess=function(J){if(!a){SessionLogger.traceTag(40425042,logCategory.PptSession,logLevel.Info,"Transcriber::onaudioprocess Transcriber instance is null");return}if(!a.m_webSocket){SessionLogger.traceTag(40425043,logCategory.PptSession,logLevel.Info,"WebSocket is null. TranscriberID: "+a.m_transcriberId);return}if(a.m_webSocket.readyState!=WebSocket.OPEN){SessionLogger.traceTag(40425044,logCategory.PptSession,logLevel.Info,"Cannot send audio data because WebSocket not open. WebSocketReadyState: "+a.m_webSocket.readyState+ +" TranscriberID: "+a.m_transcriberId);return}if(a.m_fIsRehearsal){var x=Rehearsal.GetInstance();if(x==null||x.GetRehearsalState()!=RehearsalState.Started){SessionLogger.traceTag(42074945,logCategory.PptSession,logLevel.Info,"Rehearsal session is not started yet in onaudioprocess. TranscriberID: "+a.m_transcriberId);return}}var E=Date.now(),A=a.EncodeWAVWithoutHeader(J.inputBuffer.getChannelData(0));if(TranscriberSettings.MessageType==="protobuf"){var d=new proto.Microsoft.PowerPoint.SpeechFrontDoor.ProtoBuf.ClientAudioMessage,e=Transcriber.generateId();d.setCorrelationid(e);try{var z=Date.now();a.m_messageLatencyTable[e]=z;a.m_totalEntriesInLatencyTable+=1;if(a.m_totalEntriesInLatencyTable>a.c_maxEntriesInLatencyTable){var H=6e4;a.m_latencyTableDeletedCount+=1;for(var y in a.m_messageLatencyTable){var D=a.m_messageLatencyTable[y];if(D<z-H){delete a.m_messageLatencyTable[y];a.m_totalEntriesInLatencyTable-=1}}SessionLogger.traceTag(40477776,logCategory.PptSession,logLevel.Info,"Transcriber::onaudioprocess Deleted all entries in the latency table older than 1 minute. Number of times entries in the latency table have surpassed allowed max: "+a.m_latencyTableDeletedCount+" TranscriberID: "+a.m_transcriberId)}}catch(K){SessionLogger.traceTag(40477777,logCategory.PptSession,logLevel.Warning,"Transcriber::onaudioprocess Message latency logic threw an exception "+K+" TranscriberID: "+a.m_transcriberId)}var n=new Uint8Array(A.buffer),I=n[0]==0&&n[1]==0;d.setAudio(n);d.setSourcelanguage(!a.m_fIsRehearsal?TranscriberSettings.SpeechLanguage:"en-us");d.getSettingsMap().set("targetLanguageList",TranscriberSettings.ServiceRequestTranslationLanguages);d.getSettingsMap().set("currentSlideIndex",String(a.m_currentSlideIndex));if(TranscriberSettings.IsCustomEndpointEnabled&&typeof b!=="undefined"&&b!==""){a.m_sessionTelemetry[TelemetryFieldNames.WebSocketCustomEndpoint]=b;d.getSettingsMap().set("endpointId",b)}var F=a.m_fIsRehearsal?Rehearsal.GetRehearsalMetadataJSON():"",w="";if(TranscriberSettings.fSupportSpeechResponseMessage)w=a.m_fIsRehearsal?"SpeechResultMessage,QualityStatusMessage,RehearsalResultMessage":"SpeechResultMessage,QualityStatusMessage";d.getSettingsMap().set("clientMetadata",JSON.stringify({supportedResponseTypes:w,rehearsalMetadata:F,livePragueSessionInfo:TranscriberSettings.LivePraugueSessionInfo}));if(!I){if(a.m_sendPingMessageFlag){d.getSettingsMap().set("isPingMessage","true");var l=a.m_heartbeatSendTime!==null&&a.m_heartbeatSendTime!==undefined?a.m_heartbeatSendTime:Date.now(),j=Date.now(),i=j-l;a.m_sendPingMessageFlag=false;a.m_heartbeatSendTime=j;a.m_currentHeartbeatSendInterval=i;!TranscriberSettings.IsLogEachTranscriptMessage&&i>TranscriberSettings.HeartbeatInterval+TranscriberSettings.RoundtripLatencyWarnThreshold&&SessionLogger.traceTag(41035722,logCategory.PptSession,logLevel.Warning,JSON.stringify({RealHeartbeatSendInterval:i,PreHeartbeatSendTime:l,CurHeartbeatSendTime:j,TranscriberID:a.m_transcriberId,CorrelationID:e}));TranscriberSettings.IsLogEachTranscriptMessage&&SessionLogger.traceTag(41223623,logCategory.PptSession,logLevel.Info,JSON.stringify({RealHeartbeatSendInterval:i,PreHeartbeatSendTime:l,CurHeartbeatSendTime:j,TranscriberID:a.m_transcriberId,CorrelationID:e}));if(a.m_gapNumberBetweenPingPongMessage>=2){DetectHighLatencyWithNetworkInfo(-1,TranscriberSettings.NoInternetConnectionInMs,e);SessionLogger.traceTag(41964700,logCategory.PptSession,logLevel.Error,"Transcriber::OnGetUserMediaSuccess Probably loss network connection: TranscriberID: "+a.m_transcriberId+" CorrelationID: "+e);RecordError(TelemetryErrorFieldNames.LossInternetConnection,"gapNumberBetweenPingPongMessage : "+a.m_gapNumberBetweenPingPongMessage,Date.now(),false)}a.m_gapNumberBetweenPingPongMessage=Math.min(2,a.m_gapNumberBetweenPingPongMessage+1)}var G=d.serializeBinary();if(a.m_sessionTelemetry[TelemetryFieldNames.SendFirstMessageTime]==undefined)a.m_sessionTelemetry[TelemetryFieldNames.SendFirstMessageTime]=Date.now();a.m_currentSentAudioTimeUTC=Date.now();var k=Date.now()-E;a.m_prepAudioCount++;a.m_prepAudioSum+=k;a.m_minPrepAudio=Math.min(a.m_minPrepAudio,k);a.m_maxPrepAudio=Math.max(a.m_maxPrepAudio,k);a.m_webSocket.send(G);a.m_totalAudioMessageCountInMins++}try{var B=Date.now(),L=0;a.m_totalAudioMessageCountInCurrentTimeInterval++;if(a.m_totalAudioMessageCountInPreviousTimeInterval>0&&a.m_lastSentAudioTimeUTC<Number.MAX_VALUE){var v=a.m_intervalAudio/a.m_totalAudioMessageCountInPreviousTimeInterval,m=Date.now()-a.m_lastSentAudioTimeUTC,c=v/(m>0?m:1);if(c>0){a.m_realTimeSendDataFactorCount++;a.m_realTimeSendDataFactorSum+=c;a.m_minRealTimeSendDataFactor=Math.min(a.m_minRealTimeSendDataFactor,c);a.m_maxRealTimeSendDataFactor=Math.max(a.m_maxRealTimeSendDataFactor,c);a.m_realTimeSendDataFactorCountInTimeInterval++;a.m_realTimeSendDataFactorSumInTimeInterval+=c;a.m_minRealTimeSendDataFactorInTimeInterval=Math.min(a.m_minRealTimeSendDataFactorInTimeInterval,c);a.m_maxRealTimeSendDataFactorInTimeInterval=Math.max(a.m_maxRealTimeSendDataFactorInTimeInterval,c);if(c<TranscriberSettings.RealTimeFactorLowerThreshold||c>TranscriberSettings.RealTimeFactorUpperThreshold){a.m_totalAudioFactorOutsideOfThresholdCount++;var f=0,h=0,g=0;if(a.m_realTimeSendDataFactorCount>0){f=a.m_realTimeSendDataFactorSum*1/a.m_realTimeSendDataFactorCount;h=a.m_minRealTimeSendDataFactor;g=a.m_maxRealTimeSendDataFactor}SessionLogger.traceTag(41157960,logCategory.PptSession,logLevel.Warning,JSON.stringify({MessageCorrelationID:e,SessionDurationInMS:Date.now()-TranscriberSettings.StartTime,RealTimeSendingDataFactor:c,AvgRealTimeSendingDataFactor:f,MinRealTimeSendingDataFactor:h,MaxRealTimeSendingDataFactor:g,AvgSendingDataDurationForInterval:v,RealTimeDurationForCurrentMessage:m,TotalAudioMessageCountInPreviousTimeInterval:a.m_totalAudioMessageCountInPreviousTimeInterval,AdjustedTimeInterval:a.m_intervalAudio,TranscriberID:a.m_transcriberId}))}}}if(Date.now()-a.m_lastAudioLogUTC>TranscriberSettings.DataLoggingIntervalMS){var f=0,h=0,g=0;if(a.m_realTimeSendDataFactorCount>0){f=a.m_realTimeSendDataFactorSum*1/a.m_realTimeSendDataFactorCount;h=a.m_minRealTimeSendDataFactor;g=a.m_maxRealTimeSendDataFactor}var r=0;if(a.m_totalAudioMessageCountInPreviousTimeInterval>0)r=a.m_intervalAudio/a.m_totalAudioMessageCountInPreviousTimeInterval;var o=0,q=0,p=0;if(a.m_realTimeSendDataFactorCountInTimeInterval>0){o=a.m_realTimeSendDataFactorSumInTimeInterval*1/a.m_realTimeSendDataFactorCountInTimeInterval;q=a.m_minRealTimeSendDataFactorInTimeInterval;p=a.m_maxRealTimeSendDataFactorInTimeInterval}var s=0,u=0,t=0;if(a.m_prepAudioCount>0){s=a.m_prepAudioSum/a.m_prepAudioCount;u=a.m_minPrepAudio;t=a.m_maxPrepAudio}SessionLogger.traceTag(41157961,logCategory.PptSession,logLevel.Info,JSON.stringify({SessionDurationInMS:Date.now()-TranscriberSettings.StartTime,AvgRealTimeSendingDataFactor:f,MinRealTimeSendingDataFactor:h,MaxRealTimeSendingDataFactor:g,AvgRealTimeSendingDataFactorForInterval:o,MinRealTimeSendingDataFactorForInterval:q,MaxRealTimeSendingDataFactorForInterval:p,AvgPrepAudioForInterval:s,MinPrepAudioForInterval:u,MaxPrepAudioForInterval:t,AvgSendingDataDurationForInterval:r,TotalAudioMessageCountInPreviousTimeInterval:a.m_totalAudioMessageCountInPreviousTimeInterval,AdjustedTimeInterval:a.m_intervalAudio,TranscriberID:a.m_transcriberId}));a.m_totalAudioMessageCountInPreviousTimeInterval=a.m_totalAudioMessageCountInCurrentTimeInterval;a.m_totalAudioMessageCountInCurrentTimeInterval=0;a.m_realTimeSendDataFactorCountInTimeInterval=0;a.m_realTimeSendDataFactorSumInTimeInterval=0;a.m_minRealTimeSendDataFactorInTimeInterval=Number.MAX_VALUE;a.m_maxRealTimeSendDataFactorInTimeInterval=Number.MIN_VALUE;a.m_prepAudioCount=0;a.m_prepAudioSum=0;a.m_minPrepAudio=Number.MAX_VALUE;a.m_maxPrepAudio=Number.MIN_VALUE;a.m_lastAudioLogUTC=Date.now();ResetIntervalStats(true)}a.m_lastSentAudioTimeUTC=a.m_currentSentAudioTimeUTC;var C=Date.now()-B;a.m_audioFactorCalculationDuration+=C}catch(K){SessionLogger.traceTag(41157962,logCategory.PptSession,logLevel.Warning,"Transcriber::onaudioprocess Calculating audio sending metrics threw an exception: "+K+" TranscriberID: "+a.m_transcriberId)}}else{if(a.m_sessionTelemetry[TelemetryFieldNames.SendFirstMessageTime]==undefined)a.m_sessionTelemetry[TelemetryFieldNames.SendFirstMessageTime]=Date.now();a.m_lastSentAudioTimeUTC=Date.now();a.m_webSocket.send(A.buffer)}};a.m_streamSource.connect(a.m_scriptNode);a.m_scriptNode.connect(a.m_audioCtx.destination)};